<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognito Authentication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .result {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Cognito Authentication Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Login Status</h2>
        <p>This test will check if you're currently logged in with Cognito.</p>
        <button onclick="checkLoginStatus()">Check Login Status</button>
        <div id="loginStatus" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Test Cognito Authentication</h2>
        <p>This test will attempt to get authenticated credentials and make an API call.</p>
        <button onclick="testCognitoAuth()">Test Authentication</button>
        <div id="authResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: View Token Details</h2>
        <p>This test will decode and display your ID token if you're logged in.</p>
        <button onclick="viewTokenDetails()">View Token Details</button>
        <div id="tokenDetails" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Make Authenticated API Call</h2>
        <p>This test will make an API call with your authentication token.</p>
        <button onclick="makeAuthenticatedCall()">Make API Call</button>
        <div id="apiResult" class="result"></div>
    </div>
    
    <p><a href="index.html">Back to Home</a></p>
    
    <script src="aws-config.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1001.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/amazon-cognito-identity-js/5.2.10/amazon-cognito-identity.min.js"></script>
    <script src="aws-credentials.js"></script>
    <script>
        // Function to check login status
        function checkLoginStatus() {
            const resultDiv = document.getElementById('loginStatus');
            resultDiv.style.display = 'block';
            
            const idToken = localStorage.getItem('id_token');
            const userData = localStorage.getItem('userData');
            
            if (idToken) {
                // Try to decode the token
                try {
                    const payload = JSON.parse(atob(idToken.split('.')[1]));
                    const expiration = new Date(payload.exp * 1000);
                    const isExpired = expiration < new Date();
                    
                    resultDiv.innerHTML = `
                        <h3>You are logged in!</h3>
                        <p><strong>Token expiration:</strong> ${expiration.toLocaleString()}</p>
                        <p><strong>Token status:</strong> ${isExpired ? 'EXPIRED' : 'Valid'}</p>
                        <p><strong>Username:</strong> ${payload.email || payload.username || 'Unknown'}</p>
                    `;
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>Token found but could not be decoded</h3>
                        <p>Error: ${e.message}</p>
                    `;
                }
            } else if (userData) {
                resultDiv.innerHTML = `
                    <h3>You are logged in with standard authentication</h3>
                    <p>Note: This is not using Cognito authentication.</p>
                    <p>To test Cognito, please log out and log in using the Cognito Login option.</p>
                `;
            } else {
                resultDiv.innerHTML = `
                    <h3>You are not logged in</h3>
                    <p>Please <a href="cognito-login.html">log in with Cognito</a> to test authentication.</p>
                `;
            }
        }
        
        // Function to view token details
        function viewTokenDetails() {
            const resultDiv = document.getElementById('tokenDetails');
            resultDiv.style.display = 'block';
            
            const idToken = localStorage.getItem('id_token');
            
            if (!idToken) {
                resultDiv.innerHTML = `
                    <h3>No token found</h3>
                    <p>Please log in with Cognito first.</p>
                `;
                return;
            }
            
            try {
                const payload = JSON.parse(atob(idToken.split('.')[1]));
                resultDiv.innerHTML = `
                    <h3>Token Details</h3>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                `;
            } catch (e) {
                resultDiv.innerHTML = `
                    <h3>Error decoding token</h3>
                    <p>${e.message}</p>
                `;
            }
        }
        
        // Function to make an authenticated API call
        function makeAuthenticatedCall() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Making API call...</p>';
            
            const idToken = localStorage.getItem('id_token');
            
            if (!idToken) {
                resultDiv.innerHTML = `
                    <h3>No token found</h3>
                    <p>Please log in with Cognito first.</p>
                `;
                return;
            }
            
            const API_BASE = 'https://rzscchcv11.execute-api.us-east-1.amazonaws.com/Prod';
            
            fetch(`${API_BASE}/user/me`, {
                headers: {
                    'Authorization': idToken
                }
            })
            .then(response => {
                resultDiv.innerHTML += `<p>Response status: ${response.status}</p>`;
                return response.json().catch(() => ({}));
            })
            .then(data => {
                resultDiv.innerHTML += `
                    <h3>API Response</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            })
            .catch(error => {
                resultDiv.innerHTML += `
                    <h3>Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }
    </script>
</body>
</html>