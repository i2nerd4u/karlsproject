<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealMate - Nutrition Tracker</title>
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes floatAround {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(50px, -40px) rotate(45deg);
            }
            50% {
                transform: translate(20px, 60px) rotate(90deg);
            }
            75% {
                transform: translate(-40px, 30px) rotate(45deg);
            }
        }
        
        .drop-area {
            margin-top: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            width: 100%;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .drop-area.highlight {
            border-color: #2c3e50;
            background-color: rgba(44, 62, 80, 0.1);
        }
    </style>
</head>
<body>
    <div class="floating-fruits" style="position: fixed; width: 100%; height: 100%; pointer-events: none; z-index: -1;">
        <!-- Floating fruits will be added dynamically based on user's food entries -->
    </div>
    
    <header class="header">
        <a href="index.html" class="logo" style="text-decoration: none; color: inherit; font-size: 1.5rem; font-weight: bold;">MealMate</a>
        <div class="auth-buttons" id="authButtons">

            <a href="login.html" class="btn btn-register">Sign in</a>
            <a href="register.html" class="btn btn-register">Register</a>
        </div>
    </header>

    <main class="main-content">
        <section class="welcome-section">
            <h1 class="welcome-title">Welcome <span id="welcomeUserName">to MealMate</span></h1>
            <p class="welcome-subtitle">Your personal nutrition tracker</p>
            
            <div id="guestContent">
                <p>Sign in or register to start tracking your nutrition.</p>
                <div style="margin-top: 15px;">
                    <a href="login.html" class="btn" style="background: #2c3e50; color: white; margin-right: 10px;">Sign In</a>
                    <a href="register.html" class="btn" style="background: #2c3e50; color: white;">Register</a>
                </div>
            </div>
            
            <div id="userContent" style="display: none;">
                <!-- Daily Calorie Tracker -->
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 class="section-title" style="margin: 0;">Today's progress</h2>
                        <button id="setDailyGoalBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Set Daily Goal</button>
                    </div>

                    <div id="dailyGoalInfo" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                            <div style="margin: 5px 10px;">
                                <span style="font-weight: bold;">Daily Calorie Goal:</span> 
                                <span id="dailyCalorieGoal">2000</span> calories
                            </div>
                            <div style="margin: 5px 10px;">
                                <span style="font-weight: bold;">Calories Consumed:</span> 
                                <span id="caloriesConsumed">0</span> calories
                            </div>
                            <div style="margin: 5px 10px;">
                                <span style="font-weight: bold;">Remaining:</span> 
                                <span id="caloriesRemaining">2000</span> calories
                            </div>
                        </div>
                    </div>
                    
                    <p class="progress-text" id="progressText">You have completed 0% of your calorie intake for the day.</p>
                    
                    <div class="progress-bar" style="height: 10px; background: #ecf0f1; border-radius: 5px; overflow: hidden; margin: 10px 0;">
                        <div class="progress-fill" id="progressFill" style="width: 0%; height: 100%; background: #2c3e50;"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin: 15px 0;">
                        <div style="width: 150px; height: 150px; position: relative;">
                            <svg viewBox="0 0 200 200" style="width: 100%; height: 100%;">
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#ecf0f1" stroke-width="20"/>
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#2c3e50" stroke-width="20" 
                                        stroke-dasharray="502" id="progressCircle" stroke-dashoffset="502" 
                                        transform="rotate(-90 100 100)" 
                                        style="transition: stroke-dashoffset 0.5s ease"/>
                                <text x="100" y="100" text-anchor="middle" dy="0.3em" font-size="24" font-weight="bold" fill="#2c3e50" id="progressPercent">0%</text>
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Quick Calorie Buttons -->
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Quick Add:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                            <button onclick="quickAddCalories(5)" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+5</button>
                            <button onclick="quickAddCalories(10)" style="background: #e3f2fd; color: #1976d2; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+10</button>
                            <button onclick="quickAddCalories(20)" style="background: #fff3e0; color: #f57c00; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+20</button>
                            <button onclick="quickAddCalories(50)" style="background: #fce4ec; color: #c2185b; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+50</button>
                            <button onclick="quickAddCalories(100)" style="background: #f3e5f5; color: #7b1fa2; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+100</button>
                            <button onclick="quickAddCalories(200)" style="background: #ffebee; color: #d32f2f; border: 1px solid #a0a0a0; border-radius: 15px; padding: 5px 12px; cursor: pointer; font-size: 12px; transition: all 0.2s;">+200</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <button id="addCaloriesBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-right: 10px;">Add Calories</button>
                        <button id="resetCaloriesBtn" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">Reset Calories</button>
                    </div>
                </div>
                
            
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h2 class="section-title" style="margin: 0 0 15px 0;">üíß Water Intake</h2>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <span style="font-weight: bold;">Daily Goal:</span> <span id="waterGoal">8</span> glasses
                        </div>
                        <div>
                            <span style="font-weight: bold;">Consumed:</span> <span id="waterConsumed">0</span> glasses
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin: 15px 0; gap: 5px;" id="waterGlasses">
                        Water glasses will be generated here 
                    </div>
                    
                    <div style="text-align: center;">
                        <button id="addWaterBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; margin-right: 10px;">Add Glass üíß</button>
                        <button id="resetWaterBtn" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">Reset</button>
                    </div>
                </div>
   

                <!-- AI Analysis Section -->
                <div style="background: #5ba168; color: white; padding: 30px 20px; border-radius: 15px; margin-bottom: 30px;">
                    <h2 style="text-align: center; margin-bottom: 20px; font-size: 1.8rem;">AI Nutrition Analysis</h2>
                    <p style="text-align: center; margin-bottom: 25px; opacity: 0.9;">Upload a photo for instant AI-powered nutrition insights</p>
                    
                    <!-- Buttons at top -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <input type="file" id="aiImageInput" style="display: none;" accept="image/*">
                        <button onclick="document.getElementById('aiImageInput').click()" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; margin-right: 10px;">Upload & Analyze</button>


                        <button onclick="loadImageLibrary()" style="background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px;">Load Image Library</button>
                    </div>
                    
                    <!-- Image Library Display -->
                    <div id="aiUploadArea" style="background: rgba(255, 255, 255, 0.1); border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 25px; text-align: center; margin-bottom: 15px; transition: all 0.3s ease;">
                        <div id="aiUploadContent">
                            <h3 style="margin-bottom: 12px; font-size: 1.2rem;">üìö Your Image Library</h3>
                            <div id="imageLibraryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; max-height: 300px; overflow-y: auto;"></div>
                            <p style="margin-bottom: 15px; opacity: 0.8;">Press the button above to load your uploaded labels! Click any image to analyze with AI</p>
                        </div>
                        <div id="aiUploadStatus" style="display: none; margin-top: 15px;"></div>
                    </div>
                    
                    <div id="aiNutritionResults" style="display: none; background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-top: 15px;">
                        <h3 style="margin-bottom: 15px;">üçé Analysis Results üçé</h3>
                        <div id="aiAnalysisContent"></div>
                    </div>
                </div>
                <input type="file" id="food-label-upload" style="display:none" accept="image/*" />
               
                <span id="file-name" style="display: block; text-align: center; margin-top: 10px;"></span>
                

                
                <!-- Add Calories Modal -->
                <div id="addCaloriesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
                    <div style="position: relative; width: 90%; max-width: 500px; margin: 80px auto; background-color: white; padding: 20px; border-radius: 8px;">
                        <button id="closeAddCaloriesBtn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                        <h3 style="margin-top: 0;">Add Calories</h3>
                        
                        <!-- Category tabs -->
                        <div style="display: flex; margin: 15px 0 5px; border-bottom: 1px solid #eee;">
                            <button id="searchTab" class="food-tab active" style="flex: 1; padding: 8px; background: none; border: none; border-bottom: 2px solid #2c3e50; font-weight: bold; cursor: pointer;">Search</button>
                            <button id="fruitsTab" class="food-tab" style="flex: 1; padding: 8px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer;">Fruits</button>
                            <button id="vegetablesTab" class="food-tab" style="flex: 1; padding: 8px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer;">Vegetables</button>
                        </div>
                        
                        <!-- Search tab content -->
                        <div id="searchTabContent" class="tab-content" style="display: block;">
                            <div style="margin: 15px 0;">
                                <label for="caloriesInput" style="display: block; margin-bottom: 5px;">Calories consumed:</label>
                                <input type="number" id="caloriesInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="1">
                            </div>
                            <div style="margin: 15px 0; position: relative;">
                                <label for="foodNameInput" style="display: block; margin-bottom: 5px;">Food item (optional):</label>
                                <input type="text" id="foodNameInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="e.g., Apple, Carrot, etc.">
                                <div id="searchResults" style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ddd; border-radius: 4px; z-index: 10; margin-top: 2px;"></div>
                            </div>
                            
                            <!-- My Foods dropdown -->
                            <div style="margin: 15px 0;">
                                <label for="savedFoodsSelect" style="display: block; margin-bottom: 5px;">My Saved Foods:</label>
                                <div style="display: flex; gap: 10px;">
                                    <select id="savedFoodsSelect" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="">-- Select a saved food --</option>
                                    </select>
                                    <button id="loadSavedFoodBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Load</button>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                <button id="saveFoodBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer;">Save as Custom Food</button>
                            </div>
                            
                            <div id="savedFoodMessage" style="display: none; text-align: center; padding: 10px; background-color: #e8f5e9; color: #2e7d32; border-radius: 4px; margin-top: 10px;"></div>
                        </div>
                        
                        <!-- Fruits tab content -->
                        <div id="fruitsTabContent" class="tab-content" style="display: none;">
                            <div style="margin: 15px 0; max-height: 300px; overflow-y: auto;">
                                <div id="fruitsList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666; padding: 10px; background: #e8f4fd; border-radius: 5px; border-left: 3px solid #3498db;">
                                <strong>Click any fruit to add to your nutrition!</strong><br>
                                It will also appear floating on the screen behind! ‚ùó
                            </div>
                        </div>
                        
                        <!-- Vegetables tab content -->
                        <div id="vegetablesTabContent" class="tab-content" style="display: none;">
                            <div style="margin: 15px 0; max-height: 300px; overflow-y: auto;">
                                <div id="vegetablesList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666; padding: 10px; background: #e8f5e9; border-radius: 5px; border-left: 3px solid #2ecc71;">
                                <strong>Click any vegetable to add to your nutrition!</strong><br>
                                It will also appear floating on the screen behind on the main webpage! ‚ùó
                            </div>
                        </div>
                        
                        <!-- Selected food display -->
                        <div id="selectedFood" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                            <div style="display: flex; align-items: center;">
                                <div style="width: 40px; height: 40px; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                                    <img id="selectedFoodImg" src="" alt="" style="max-width: 40px; max-height: 40px; object-fit: contain;">
                                    <div id="selectedFoodEmoji" style="font-size: 30px; display: none;"></div>
                                </div>
                                <div>
                                    <div id="selectedFoodName" style="font-weight: bold;"></div>
                                    <div id="selectedFoodCalories"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="submitCaloriesBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; width: 100%;">Add Calories</button>
                    </div>
                </div>
                
                <!-- Set Daily Goal Modal -->
                <div id="setGoalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
                    <div style="position: relative; width: 90%; max-width: 400px; margin: 100px auto; background-color: white; padding: 20px; border-radius: 8px;">
                        <button id="closeSetGoalBtn" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                        <h3 style="margin-top: 0;">Set Daily Calorie Goal</h3>
                        <div style="margin: 15px 0;">
                            <label for="goalInput" style="display: block; margin-bottom: 5px;">Daily calorie goal:</label>

                            <input type="number" id="goalInput" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" min="500" value="2000">

                        </div>
                        <button id="submitGoalBtn" style="background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 8px 15px; cursor: pointer; width: 100%;">Set Goal</button>
                    </div>
                </div>
                
                <!-- Health Info Modal -->
                <div id="healthInfoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
                    <div style="position: relative; width: 90%; max-width: 500px; margin: 50px auto; background-color: white; padding: 30px; border-radius: 10px;">
                        <button id="closeHealthInfoBtn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                        <h2 style="margin-top: 0; color: #333;">Tell us about yourself</h2>
                        <p style="color: #666; margin-bottom: 20px;">Help us provide better nutritional insights by sharing some basic information.</p>
                        
                        <form id="healthInfoForm">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label for="modalAge" style="display: block; margin-bottom: 5px; font-weight: bold;">Age</label>
                                    <input type="number" id="modalAge" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" min="1" max="120">
                                </div>
                                <div>
                                    <label for="modalWeight" style="display: block; margin-bottom: 5px; font-weight: bold;">Weight (kg)</label>
                                    <input type="number" id="modalWeight" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" min="1" step="0.1">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label for="modalHeight" style="display: block; margin-bottom: 5px; font-weight: bold;">Height (cm)</label>
                                    <input type="number" id="modalHeight" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" min="1" max="300">
                                </div>
                                <div>
                                    <label for="modalCalorieGoal" style="display: block; margin-bottom: 5px; font-weight: bold;">Daily Calorie Goal</label>
                                    <input type="number" id="modalCalorieGoal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" min="500" value="2000">
                                </div>
                            </div>
                            <button type="submit" style="width: 100%; background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border: none; border-radius: 5px; padding: 12px; font-size: 16px; cursor: pointer;">Save Health Information</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <div id="nutritionContent" style="display: none;">

            <section class="breakdown-section">
                <h2 class="section-title">Let's break it down</h2>
                <style>
                    .breakdown-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 25px;
                        margin-top: 20px;
                    }
                    
                    .breakdown-card {
                        padding: 20px;
                        border-radius: 10px;
                        color: white;
                        position: relative;
                        height: 280px;
                        overflow: hidden;
                        cursor: pointer;
                        transition: transform 0.3s ease;
                    }
                    
                    .breakdown-card .chart-container {
                        width: 120px;
                        height: 120px;
                        margin: 0 auto 15px;
                    }
                    
                    .breakdown-card h3 {
                        margin: 0;
                        font-size: 1.5rem;
                        text-align: center;
                    }
                    
                    .breakdown-card p {
                        margin: 5px 0 0;
                        text-align: center;
                    }
                    
                    .breakdown-card .description {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: inherit;
                        padding: 20px;
                        box-sizing: border-box;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                        text-align: center;
                    }
                    
                    .breakdown-card .description p {
                        font-size: 0.9rem;
                        margin: 5px 0;
                    }
                    
                    .breakdown-card:hover .description {
                        opacity: 1;
                    }
                    
                    .carbs {
                        background: linear-gradient(135deg, #3498db, #2980b9);
                    }
                    
                    .protein {
                        background: linear-gradient(135deg, #e74c3c, #c0392b);
                    }
                    
                    .vitamins {
                        background: linear-gradient(135deg, #2ecc71, #27ae60);
                    }
                </style>
                <div class="breakdown-grid" id="breakdownGrid">
                    <!-- Dynamic content will be populated here -->
                </div>
            </section>

            <section class="recommendations-section">
                <div class="recommendations-content" id="recommendationsContent">
                    <h2>Some recommendations from us...</h2>
                    <h2>----------------------------</h2>
                    <div id="recommendationsList">

                        <!-- Dynamic recommendations will be populated here -->
                    </div>
                </div>
                
                <div class="progress-chart">
                    <h3>Your progress over the past week</h3>
                    <svg id="calorieChart" viewBox="0 0 280 160" style="width: 100%; height: 160px;">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#3498db"/>
                                <stop offset="100%" style="stop-color:#2980b9"/>
                            </linearGradient>
                        </defs>
                        <!-- X-axis -->
                        <line x1="20" y1="140" x2="260" y2="140" stroke="#ccc" stroke-width="1"/>
                        
                        <!-- Y-axis -->
                        <line x1="20" y1="20" x2="20" y2="140" stroke="#ccc" stroke-width="1"/>
                        
                        <!-- X-axis labels (days) -->
                        <text x="20" y="155" text-anchor="middle" font-size="10" fill="#666" id="day0">Mon</text>
                        <text x="60" y="155" text-anchor="middle" font-size="10" fill="#666" id="day1">Tue</text>
                        <text x="100" y="155" text-anchor="middle" font-size="10" fill="#666" id="day2">Wed</text>
                        <text x="140" y="155" text-anchor="middle" font-size="10" fill="#666" id="day3">Thu</text>
                        <text x="180" y="155" text-anchor="middle" font-size="10" fill="#666" id="day4">Fri</text>
                        <text x="220" y="155" text-anchor="middle" font-size="10" fill="#666" id="day5">Sat</text>
                        <text x="260" y="155" text-anchor="middle" font-size="10" fill="#666" id="day6">Sun</text>
                        
                        <!-- Y-axis labels (calories) -->
                        <text x="15" y="140" text-anchor="end" font-size="10" fill="#666" id="cal0">0</text>
                        <text x="15" y="100" text-anchor="end" font-size="10" fill="#666" id="cal1">500</text>
                        <text x="15" y="60" text-anchor="end" font-size="10" fill="#666" id="cal2">1000</text>
                        <text x="15" y="20" text-anchor="end" font-size="10" fill="#666" id="cal3">1500</text>
                        
                        <!-- The line will be added dynamically -->
                        <polyline id="caloriePolyline" points="" fill="none" stroke="url(#gradient)" stroke-width="3"/>
                        
                        <!-- Data points will be added dynamically -->
                        <g id="dataPoints"></g>
                    </svg>
                </div>
            </section>
        </div>
        

    </main>

    <footer class="footer">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto;">
            <a href="meal-planner.html" class="btn" style="background: #2c3e50; color: white; text-decoration: none; padding: 1px 15px; border-radius: 4px; font-size: 14px;">Weekly Meal Planner</a>
        </div>
    </footer>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1001.0.min.js"></script>
    <script src="https://unpkg.com/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js" crossorigin="anonymous"></script>
    <script src="aws-config.js"></script>
    
    <!-- 
    COGNITO CONFIGURATION UPDATE NEEDED:
    - User Pool ID: eu-north-1_kj8Is5Leb
    - Region: eu-north-1
    - Domain: Updated to default format
    - Client ID: REPLACE '5jhuae77guiifjhid4uup14865' with actual app client ID from User Pool
    -->

    <script src="cognito-auth.js"></script>
    <script src="nutrition-db.js"></script>
    <script src="floating-fruits.js"></script>
    <script src="calorie-tracker.js"></script>
    <script>
        // Handle Cognito callback
        function handleCognitoCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                fetch(`https://mealmate.auth.eu-north-1.amazoncognito.com/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: '5jhuae77guiifjhid4uup14865',
                        code: code,
                        redirect_uri: window.location.href.split('?')[0]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.access_token) {
                        const idToken = data.id_token;
                        const payload = JSON.parse(atob(idToken.split('.')[1]));
                        
                        localStorage.setItem('access_token', data.access_token);
                        localStorage.setItem('id_token', data.id_token);
                        localStorage.setItem('isLoggedIn', 'true');
                        
                        const userData = {
                            userId: payload.sub,
                            email: payload.email,
                            name: payload.name || payload.email,
                            cognitoId: payload.sub
                        };
                        
                        // Store user data locally (API not deployed yet)
                        localStorage.setItem('userData', JSON.stringify(userData));
                        window.history.replaceState({}, document.title, window.location.pathname);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Token exchange failed:', error);
                });
            }
        }
        
        handleCognitoCallback();
        
        // Direct Cognito authentication functions
        window.showLoginForm = function() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            if (email && password) {
                loginUser(email, password);
            }
        };
        
        window.showRegisterForm = function() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            if (email && password) {
                registerUser(email, password);
            }
        };
        
        function loginUser(email, password) {
            // Simple login - store user data locally
            const userData = {
                userId: 'user_' + Date.now(),
                email: email,
                name: email.split('@')[0]
            };
            
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userData', JSON.stringify(userData));
            location.reload();
        }
        
        function registerUser(email, password) {
            // Simple registration - store user data locally
            const userData = {
                userId: 'user_' + Date.now(),
                email: email,
                name: email.split('@')[0]
            };
            
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userData', JSON.stringify(userData));
            location.reload();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE = 'https://rzscchcv11.execute-api.us-east-1.amazonaws.com/prod';
            
            // Add click event listeners to breakdown cards
            const breakdownCards = document.querySelectorAll('.breakdown-card');
            breakdownCards.forEach(card => {
                card.addEventListener('click', function() {
                    const description = this.querySelector('.description');
                    if (description.style.opacity === '1') {
                        description.style.opacity = '0';
                    } else {
                        // Hide all descriptions first
                        document.querySelectorAll('.breakdown-card .description').forEach(desc => {
                            desc.style.opacity = '0';
                        });
                        // Show this description
                        description.style.opacity = '1';
                    }
                });
            });
            
            // Function to add a floating emoji to the background
            window.addFloatingEmoji = function(emoji) {
                const floatingFruits = document.querySelector('.floating-fruits');
                if (!floatingFruits) return;
                
                // Get current user ID
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const userId = userData.userId || 'guest';
                
                // Create a new floating fruit element
                const floatingFruit = document.createElement('div');
                floatingFruit.className = 'floating-fruit';
                floatingFruit.style.position = 'absolute';
                floatingFruit.style.fontSize = '2rem';
                floatingFruit.style.opacity = '0';
                floatingFruit.style.animation = `floatAround ${20 + Math.random() * 15}s ease-in-out infinite ${Math.random() * 10}s`;
                floatingFruit.style.top = `${Math.random() * 80}%`;
                floatingFruit.style.left = `${Math.random() * 80}%`;
                floatingFruit.textContent = emoji;
                
                // Add to the container
                floatingFruits.appendChild(floatingFruit);
                
                // Fade in
                setTimeout(() => {
                    floatingFruit.style.transition = 'opacity 1s ease';
                    floatingFruit.style.opacity = '0.5';
                }, 100);
                
                // Store the emojis in localStorage to persist between page loads (user-specific)
                const userEmojis = JSON.parse(localStorage.getItem(`userFoodEmojis_${userId}`) || '[]');
                if (userEmojis.length >= 20) {
                    userEmojis.shift(); // Remove oldest emoji if we have too many
                }
                userEmojis.push(emoji);
                localStorage.setItem(`userFoodEmojis_${userId}`, JSON.stringify(userEmojis));
            }
            // Check if user is logged in
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userDataString = localStorage.getItem('userData');
            const idToken = localStorage.getItem('id_token');
            
            if ((isLoggedIn && userDataString) || idToken) {
                try {
                    let userName = 'User';
                    
                    if (userDataString) {
                        const userData = JSON.parse(userDataString);
                        userName = userData.name || 'User';
                    } else if (idToken) {
                        // Parse the JWT token
                        const payload = JSON.parse(atob(idToken.split('.')[1]));
                        userName = payload.name || payload.email || 'User';
                    }
                    
                    // Update welcome message
                    document.getElementById('welcomeUserName').textContent = userName;
                    
                    // Update auth buttons
                    document.getElementById('authButtons').innerHTML = `
                        <a href="nutrition-analysis.html" class="btn" style="background: #2c3e50; color: white; margin-right: 10px; display: flex; align-items: center; justify-content: center;">AI Tracker</a>
                        <a href="user_dashboard.html" class="btn" style="background: #2c3e50; color: white; margin-right: 10px; display: flex; align-items: center; justify-content: center;">Dashboard</a>
                        <button id="logoutBtn" class="btn" style="background: #e74c3c; color: white; display: flex; align-items: center; justify-content: center;">Logout</button>
                    `;
                    
                    // Show user content
                    document.getElementById('userContent').style.display = 'block';
                    document.getElementById('nutritionContent').style.display = 'block';
                    document.getElementById('guestContent').style.display = 'none';
                    
                    // Show health info banner for logged in users
                    const healthBanner = document.getElementById('healthInfoBanner');
                    if (healthBanner) {
                        healthBanner.style.display = 'block';
                    }
                    
                    // Get current user ID
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const userId = userData.userId || 'guest';
                    
                    // Clear any existing floating fruits
                    const floatingFruits = document.querySelector('.floating-fruits');
                    if (floatingFruits) {
                        floatingFruits.innerHTML = '';
                    }
                    
                    // Add the 4 default fruit emojis
                    const defaultFruits = ['üçé', 'üçå', 'üçä', 'ü•ë'];
                    
                    // Load user-specific saved food emojis
                    const userEmojis = JSON.parse(localStorage.getItem(`userFoodEmojis_${userId}`) || '[]');
                    
                    // Start with default fruits if user has no saved emojis
                    const fruitsToShow = userEmojis.length > 0 ? userEmojis : defaultFruits;
                    
                    // Limit to showing only 4 fruits at a time
                    const limitedFruits = fruitsToShow.slice(-4);
                    
                    // Add the fruits to the background
                    limitedFruits.forEach(emoji => {
                        setTimeout(() => addFloatingEmoji(emoji), Math.random() * 1000);
                    });
                    
                    // Add logout functionality
                    document.getElementById('logoutBtn').addEventListener('click', function() {
                        // Clear local storage
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('userData');
                        localStorage.removeItem('id_token');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        
                        // Simple redirect to home page instead of Cognito logout
                        window.location.href = 'index.html';
                    });
                    
                    // Set up drag and drop functionality for both drop areas
                    const dropArea = document.getElementById('drop-area');
                    const fileInput = document.getElementById('food-label-upload');
                    const fileName = document.getElementById('file-name');
                    
                    // Also set up drag and drop for AI section drop area
                    const aiDropArea = document.querySelector('#drop-area');
                    if (aiDropArea) {
                        setupDragAndDrop(aiDropArea, fileInput, fileName);
                    }
                    
                    function setupDragAndDrop(dropElement, inputElement, nameElement) {
                    
                    // Prevent default drag behaviors
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropElement.addEventListener(eventName, preventDefaults, false);
                    });
                    
                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    
                    // Highlight drop area when item is dragged over it
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropElement.addEventListener(eventName, () => dropElement.classList.add('highlight'), false);
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        dropElement.addEventListener(eventName, () => dropElement.classList.remove('highlight'), false);
                    });
                    
                    // Handle dropped files
                    dropElement.addEventListener('drop', handleDrop, false);
                    
                    function handleDrop(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        
                        if (files.length > 0) {
                            uploadToS3AndAnalyze(files[0]);
                        }
                    }
                    }
                    
                    // Set up the main drop area
                    if (dropArea) {
                        setupDragAndDrop(dropArea, fileInput, fileName);
                    }
                    
                    function handleFiles(files, dropElement, nameElement) {
                        if (files.length > 0) {
                            const file = files[0];
                            if (nameElement) nameElement.textContent = file.name;
                            const reader = new FileReader();
                            reader.onload = function () {
                                // Remove any existing preview box
                                const existingPreviewBox = document.getElementById('preview-box');
                                if (existingPreviewBox) {
                                    dropElement.removeChild(existingPreviewBox);
                                }
                                
                                // Create preview box with AI section styling
                                const previewBox = document.createElement('div');
                                previewBox.id = 'preview-box';
                                previewBox.style.background = 'rgba(255, 255, 255, 0.1)';
                                previewBox.style.border = '2px dashed rgba(255, 255, 255, 0.3)';
                                previewBox.style.borderRadius = '12px';
                                previewBox.style.padding = '20px';
                                previewBox.style.textAlign = 'center';
                                previewBox.style.color = 'white';
                                
                                // Create image preview
                                const imgPreview = document.createElement('img');
                                imgPreview.src = reader.result;
                                imgPreview.style.width = 'auto';
                                imgPreview.style.maxWidth = '100%';
                                imgPreview.style.maxHeight = '200px';
                                imgPreview.style.marginBottom = '15px';
                                imgPreview.style.borderRadius = '8px';
                                previewBox.appendChild(imgPreview);
                                
                                // Create button container
                                const buttonContainer = document.createElement('div');
                                buttonContainer.style.display = 'flex';
                                buttonContainer.style.justifyContent = 'center';
                                buttonContainer.style.gap = '10px';
                                buttonContainer.style.marginBottom = '10px';
                                
                                // Create upload button
                                const uploadButton = document.createElement('button');
                                uploadButton.textContent = 'Upload';
                                uploadButton.style.padding = '8px 20px';
                                uploadButton.style.backgroundColor = '#2ecc71';
                                uploadButton.style.color = 'white';
                                uploadButton.style.border = 'none';
                                uploadButton.style.borderRadius = '20px';
                                uploadButton.style.cursor = 'pointer';
                                uploadButton.style.fontSize = '14px';
                                
                                // Create discard button
                                const discardButton = document.createElement('button');
                                discardButton.textContent = 'Discard';
                                discardButton.style.padding = '8px 20px';
                                discardButton.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                discardButton.style.color = 'white';
                                discardButton.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                                discardButton.style.borderRadius = '20px';
                                discardButton.style.cursor = 'pointer';
                                discardButton.style.fontSize = '14px';
                                
                                // Add buttons to container
                                buttonContainer.appendChild(uploadButton);
                                buttonContainer.appendChild(discardButton);
                                previewBox.appendChild(buttonContainer);
                                
                                // Create dashboard link (initially hidden)
                                const dashboardLink = document.createElement('div');
                                dashboardLink.id = 'dashboardLink';
                                dashboardLink.style.display = 'none';
                                dashboardLink.innerHTML = '<a href="user_dashboard.html" style="color: white; text-decoration: underline; opacity: 0.9;">View in Dashboard</a>';
                                previewBox.appendChild(dashboardLink);
                                
                                // Clear drop area content
                                dropElement.innerHTML = '';
                                
                                // Add preview box to drop area
                                dropElement.appendChild(previewBox);
                                
                                // Upload button functionality
                                uploadButton.addEventListener('click', function() {
                                    // Disable button to prevent double-clicks
                                    uploadButton.disabled = true;
                                    uploadButton.textContent = 'Uploading...';
                                    
                                    // Get user data
                                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                                    const userId = userData.userId || 'user_' + Date.now();
                                    
                                    // Extract base64 data from the data URL
                                    const base64 = reader.result.split(',')[1];
                                    
                                    // Upload to API
                                    fetch(`https://008zc5o3r8.execute-api.eu-north-1.amazonaws.com/Prod/upload-image`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            imageBase64: base64,
                                            fileType: file.type,
                                            userId: userId
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Image uploaded successfully:', data);
                                        
                                        // Save image data to localStorage
                                        const imageData = {
                                            imageId: 'img_' + Date.now(),
                                            userId: userId,
                                            imageUrl: data.imageUrl,
                                            imageData: reader.result.substring(0, 50000),
                                            filename: file.name,
                                            filesize: file.size,
                                            fileType: file.type,
                                            uploadDate: new Date().toISOString()
                                        };
                                        
                                        let userImages = JSON.parse(localStorage.getItem('userImages') || '[]');
                                        // Keep only last 10 images to prevent quota issues
                                        if (userImages.length >= 10) {
                                            userImages = userImages.slice(-9);
                                        }
                                        
                                        userImages.push(imageData);
                                        localStorage.setItem('userImages', JSON.stringify(userImages));
                                        
                                        // Show success message and dashboard link
                                        uploadButton.textContent = 'Uploaded to S3!';
                                        uploadButton.style.backgroundColor = '#27ae60';
                                        document.getElementById('dashboardLink').style.display = 'block';
                                        
                                        setTimeout(() => {
                                            uploadButton.textContent = 'Upload';
                                            uploadButton.style.backgroundColor = '#2ecc71';
                                            uploadButton.disabled = false;
                                        }, 2000);
                                    })
                                    .catch(err => {
                                        console.error('API upload error:', err);
                                        uploadButton.textContent = 'Upload Failed';
                                        uploadButton.style.backgroundColor = '#e74c3c';
                                        
                                        setTimeout(() => {
                                            uploadButton.textContent = 'Upload';
                                            uploadButton.style.backgroundColor = '#3498db';
                                            uploadButton.disabled = false;
                                        }, 2000);
                                    });
                                });
                                
                                // Discard button functionality
                                discardButton.addEventListener('click', function() {
                                    // Simply reload the page to restore everything to original state
                                    window.location.reload();
                                });
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                    
                    // Handle file input change
                    fileInput.addEventListener('change', function() {
                        handleFiles(this.files, dropArea, fileName);
                    });
                    
                    // Handle AI image input
                    const aiImageInput = document.getElementById('aiImageInput');
                    if (aiImageInput) {
                        aiImageInput.addEventListener('change', function() {
                            const file = this.files[0];
                            if (file) {
                                uploadToS3AndAnalyze(file);
                            }
                        });
                    }
                    
                    // Function to upload to S3 and then analyze
                    async function uploadToS3AndAnalyze(file) {
                        try {
                            showAIUploadStatus('üì§ Uploading to S3...', 'loading');
                            
                            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                            const userId = userData.userId || 'user_' + Date.now();
                            
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                const base64 = e.target.result.split(',')[1];
                                
                                try {
                                    // Simulate API response (API not deployed yet)
                                    const data = { imageUrl: 'local-storage-image' };
                                    
                                    // Save to localStorage
                                    const imageData = {
                                        imageId: 'img_' + Date.now(),
                                        userId: userId,
                                        imageUrl: data.imageUrl,
                                        imageData: e.target.result,
                                        filename: file.name,
                                        filesize: file.size,
                                        fileType: file.type,
                                        uploadDate: new Date().toISOString()
                                    };
                                    
                                    let userImages = JSON.parse(localStorage.getItem('userImages') || '[]');
                                    userImages.push(imageData);
                                    localStorage.setItem('userImages', JSON.stringify(userImages));
                                    
                                    showAIUploadStatus('‚úÖ Uploaded to S3! Now analyzing...', 'success');
                                    
                                    // Refresh image library
                                    autoLoadImageLibrary();
                                    
                                    // Now analyze with AI
                                    analyzeImageWithAI(file);
                                    
                                } catch (uploadError) {
                                    console.error('S3 upload failed:', uploadError);
                                    showAIUploadStatus('‚ö†Ô∏è S3 upload failed, analyzing locally...', 'error');
                                    analyzeImageWithAI(file);
                                }
                            };
                            reader.readAsDataURL(file);
                            
                        } catch (error) {
                            console.error('Upload error:', error);
                            showAIUploadStatus('‚ùå Upload failed, analyzing locally...', 'error');
                            analyzeImageWithAI(file);
                        }
                    }
                    
                    // Load Image Library function
                    window.loadImageLibrary = function() {
                        const userImages = JSON.parse(localStorage.getItem('userImages') || '[]');
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        const userSpecificImages = userImages.filter(img => img.userId === userId);
                        
                        if (userSpecificImages.length === 0) {
                            showAIUploadStatus('No images found in your library. Upload some images first!', 'error');
                            return;
                        }
                        
                        displayImageLibrary(userSpecificImages);
                    };
                    
                    // Auto-load image library function
                    function autoLoadImageLibrary() {
                        const userImages = JSON.parse(localStorage.getItem('userImages') || '[]');
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        const userSpecificImages = userImages.filter(img => img.userId === userId);
                        
                        if (userSpecificImages.length > 0) {
                            displayImageLibrary(userSpecificImages);
                        }
                    }
                    
                    function displayImageLibrary(images) {
                        const aiUploadContent = document.getElementById('aiUploadContent');
                        
                        aiUploadContent.innerHTML = `
                            <h3 style="margin-bottom: 12px; font-size: 1.2rem;">üìö Select Image to Analyze</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
                                ${images.map((img, index) => `
                                    <div onclick="analyzeLibraryImage('${img.imageId}')" style="cursor: pointer; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 5px; transition: all 0.3s ease;" onmouseover="this.style.borderColor='white'" onmouseout="this.style.borderColor='rgba(255,255,255,0.3)'">
                                        <img src="${img.imageData}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 5px;">
                                        <div style="font-size: 10px; text-align: center; opacity: 0.8;">${img.filename}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="resetAIUpload()" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">Back to Upload</button>
                        `;
                    }
                    
                    window.analyzeLibraryImage = function(imageId) {
                        const userImages = JSON.parse(localStorage.getItem('userImages') || '[]');
                        const image = userImages.find(img => img.imageId === imageId);
                        
                        if (image && image.imageData) {
                            showAIUploadStatus('üîÑ Analyzing image with AI...', 'loading');
                            
                            const base64 = image.imageData.includes(',') ? image.imageData.split(',')[1] : image.imageData;
                            
                            fetch(`https://008zc5o3r8.execute-api.eu-north-1.amazonaws.com/Prod/analyze`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    image: base64
                                })
                            })
                            .then(response => response.json())
                            .then(result => {
                                if (result.success) {
                                    showAIUploadStatus('‚úÖ Analysis completed!', 'success');
                                    displayAINutritionAnalysis(result.analysis, result.filename, result, image.imageData);
                                    updateBreakdownCards(); // Update breakdown cards after analysis
                                    updateRecommendations(); // Update recommendations after analysis
                                    // saveAIAnalysisToStorage({ name: image.filename, type: image.fileType }, result);
                                } else {
                                    showAIUploadStatus(`‚ùå Error: ${result.error}`, 'error');
                                }
                            })
                            .catch(err => {
                                console.error('Analysis error:', err);
                                showAIUploadStatus(`‚ùå Analysis failed: ${err.message || 'Network error'}`, 'error');
                            });
                        } else {
                            showAIUploadStatus('‚ùå Image data not found', 'error');
                        }
                    };
                    
                    window.resetAIUpload = function() {
                        const aiUploadContent = document.getElementById('aiUploadContent');
                        aiUploadContent.innerHTML = `
                            <h3 style="margin-bottom: 12px; font-size: 1.2rem;">üì∏ Upload Food Image</h3>
                            <p style="margin-bottom: 15px;">Drag and drop or click to select</p>
                            <input type="file" id="aiImageInput" style="display: none;" accept="image/*">
                            <button onclick="document.getElementById('aiImageInput').click()" style="background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid rgba(255, 255, 255, 0.3); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; margin-right: 10px;">Upload & Analyze</button>
                            <button onclick="loadImageLibrary()" style="background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px;">Load Image Library</button>
                        `;
                        
                        const newAiImageInput = document.getElementById('aiImageInput');
                        if (newAiImageInput) {
                            newAiImageInput.addEventListener('change', function() {
                                const file = this.files[0];
                                if (file) {
                                    analyzeImageWithAI(file);
                                }
                            });
                        }
                    };
                    
                    // AI Analysis Functions
                    async function analyzeImageWithAI(file) {
                        showAIUploadStatus('üîÑ Analyzing image with AI...', 'loading');
                        
                        try {
                            // Convert file to base64
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                const base64 = e.target.result.split(',')[1];
                                
                                try {
                                    // Simulate AI analysis (API not deployed yet)
                                    const result = {
                                        success: true,
                                        analysis: 'AI analysis not available - API Gateway not deployed yet. This is a placeholder response.',
                                        filename: 'uploaded-image.jpg'
                                    };
                                    
                                    if (result.success) {
                                        showAIUploadStatus('‚úÖ Analysis completed!', 'success');
                                        displayAINutritionAnalysis(result.analysis, result.filename, result, e.target.result);
                                        updateBreakdownCards(); // Update breakdown cards after new analysis
                                        updateRecommendations(); // Update recommendations after new analysis
                                        // saveAIAnalysisToStorage(file, result); // Removed to prevent duplicate S3 upload
                                    } else {
                                        showAIUploadStatus(`‚ùå Error: ${result.error}`, 'error');
                                    }
                                } catch (apiError) {
                                    console.error('API analysis error:', apiError);
                                    showAIUploadStatus(`‚ùå Analysis failed: ${apiError.message || 'API error'}`, 'error');
                                }
                            };
                            reader.readAsDataURL(file);
                            
                        } catch (error) {
                            console.error('AI analysis error:', error);
                            showAIUploadStatus(`‚ùå Analysis failed: ${error.message}`, 'error');
                        }
                    }
                    
                    function showAIUploadStatus(message, type) {
                        const statusDiv = document.getElementById('aiUploadStatus');
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = message;
                        
                        statusDiv.className = '';
                        if (type === 'success') {
                            statusDiv.style.color = '#2ecc71';
                        } else if (type === 'error') {
                            statusDiv.style.color = '#e74c3c';
                        } else {
                            statusDiv.style.color = 'white';
                        }
                    }
                    

                    function displayAINutritionAnalysis(analysis, filename, result, imageData) {
                        // Handle both string and object analysis responses
                        let analysisText = '';
                        let calories = 0;
                        
                        if (typeof analysis === 'string') {
                            analysisText = analysis;
                            // Match calories, cal, or kcal
                            const caloriesMatch = analysis.match(/(\d+)\s*(calories?|kcal|cal)\b/i);
                            calories = caloriesMatch ? parseInt(caloriesMatch[1]) : 0;
                        } else if (typeof analysis === 'object') {
                            analysisText = JSON.stringify(analysis, null, 2);
                            calories = analysis.calories || 0;
                            
                            if (!calories && analysis.product_name) {
                                const caloriesMatch = JSON.stringify(analysis).match(/(\d+)\s*(calories?|kcal|cal)\b/i);
                                calories = caloriesMatch ? parseInt(caloriesMatch[1]) : 0;
                            }
                        }
                        
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        const foodName = filename ? filename.replace(/\.[^/.]+$/, "") : 'Food Item';
                        
                        // Save to localStorage for nutrition-analysis.html
                        const analysisEntry = {
                            id: 'analysis_' + Date.now(),
                            userId: userId,
                            filename: filename || 'Image',
                            imageData: imageData,
                            analysis: analysisText,
                            calories: calories,
                            foodName: foodName,
                            timestamp: new Date().toISOString(),
                            type: 'ai_analysis'
                        };
                        
                        let aiAnalyses = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                        aiAnalyses.unshift(analysisEntry); // Add to beginning
                        
                        // Keep only last 20 analyses
                        if (aiAnalyses.length > 20) {
                            aiAnalyses = aiAnalyses.slice(0, 20);
                        }
                        
                        localStorage.setItem('aiAnalysisEntries', JSON.stringify(aiAnalyses));
                        
                        // Display the full analysis with link to nutrition page
                        const resultsDiv = document.getElementById('aiNutritionResults');
                        const contentDiv = document.getElementById('aiAnalysisContent');
                        
                        const timestamp = new Date().toLocaleTimeString();
                        const analysisDisplay = document.createElement('div');
                        analysisDisplay.style.cssText = 'border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; margin-bottom: 20px;';
                        analysisDisplay.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #2ecc71;">ü§ñ AI Analysis Results</h4>
                                <span style="font-size: 12px; opacity: 0.7;">${timestamp}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                    <img src="${imageData}" style="width: 100%; max-height: 150px; object-fit: contain; border-radius: 4px; margin-bottom: 8px;">
                                    <div style="font-size: 12px; opacity: 0.8;">${filename || 'Image'}</div>
                                </div>
                                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0;">Analysis:</h4>
                                    <div style="white-space: pre-wrap; line-height: 1.6; font-size: 14px; max-height: 200px; overflow-y: auto;">${analysisText}</div>
                                </div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>Calories Found: ${calories}</strong>
                                </div>
                                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="addToCalorieCounter(${calories}, '${foodName}')" style="background: ${calories > 0 ? '#2ecc71' : '#95a5a6'}; color: white; border: none; padding: 12px 24px; border-radius: 20px; cursor: ${calories > 0 ? 'pointer' : 'not-allowed'}; font-size: 14px; font-weight: bold;" ${calories <= 0 ? 'disabled' : ''}>
                                        Add ${calories} calories
                                    </button>
                                    <a href="nutrition-analysis.html" style="background: #2c3e50; color: white; padding: 12px 24px; border-radius: 20px; text-decoration: none; font-weight: bold; display: inline-block;">View All Analyses</a>
                                </div>
                            </div>
                        `;
                        
                        contentDiv.insertBefore(analysisDisplay, contentDiv.firstChild);
                        resultsDiv.style.display = 'block';
                        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    // Enhanced AI Display Function - Part 1: Main Function
                    function displayAINutritionAnalysis(analysis, filename, result, imageData) {
                        // Handle both string and object analysis responses
                        let analysisData = {};
                        let calories = 0;
                        let hasNutritionInfo = false;
                        
                        if (typeof analysis === 'string') {
                            // Try to parse as JSON first
                            try {
                                analysisData = JSON.parse(analysis);
                            } catch (e) {
                                // If not JSON, treat as plain text
                                analysisData = { raw_analysis: analysis };
                            }
                            
                            // Extract calories from text
                            const caloriesMatch = analysis.match(/(\d+)\s*(calories?|kcal|cal)\b/i);
                            calories = caloriesMatch ? parseInt(caloriesMatch[1]) : 0;
                            
                            // Check if it contains nutrition info
                            hasNutritionInfo = /nutrition|calorie|protein|fat|carb|vitamin|mineral/i.test(analysis);
                        } else if (typeof analysis === 'object') {
                            analysisData = analysis;
                            calories = extractNumericValue(analysis.calories) || 0;
                            
                            // Check if object has nutrition data
                            hasNutritionInfo = !!(analysis.calories || analysis.protein || analysis.fat || analysis.carbs || 
                                                analysis.total_fat || analysis.sodium || analysis.product_name);
                        }
                        
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        const foodName = filename ? filename.replace(/\.[^/.]+$/, "") : 'Food Item';
                        
                        // Convert analysis data to readable string for storage
                        let analysisText = '';
                        if (typeof analysisData === 'object') {
                            if (analysisData.raw_analysis) {
                                analysisText = analysisData.raw_analysis;
                            } else {
                                analysisText = JSON.stringify(analysisData, null, 2);
                            }
                        } else {
                            analysisText = String(analysisData);
                        }
                        
                        // Save to localStorage for nutrition-analysis.html
                        const analysisEntry = {
                            id: 'analysis_' + Date.now(),
                            userId: userId,
                            filename: filename || 'Image',
                            imageData: imageData,
                            analysis: analysisText,
                            calories: calories,
                            foodName: foodName,
                            timestamp: new Date().toISOString(),
                            type: 'ai_analysis',
                            hasNutritionInfo: hasNutritionInfo
                        };
                        
                        let aiAnalyses = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                        aiAnalyses.unshift(analysisEntry);
                        
                        if (aiAnalyses.length > 20) {
                            aiAnalyses = aiAnalyses.slice(0, 20);
                        }
                        
                        localStorage.setItem('aiAnalysisEntries', JSON.stringify(aiAnalyses));
                        
                        // Create enhanced display
                        const resultsDiv = document.getElementById('aiNutritionResults');
                        const contentDiv = document.getElementById('aiAnalysisContent');
                        
                        const timestamp = new Date().toLocaleTimeString();
                        const analysisDisplay = document.createElement('div');
                        analysisDisplay.style.cssText = 'border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 25px; margin-bottom: 25px;';
                        
                        // Generate enhanced HTML based on content type
                        if (hasNutritionInfo) {
                            analysisDisplay.innerHTML = generateNutritionAnalysisHTML(analysisData, calories, filename, imageData, timestamp, foodName);
                        } else {
                            analysisDisplay.innerHTML = generateGeneralAnalysisHTML(analysisData, filename, imageData, timestamp);
                        }
                        
                        contentDiv.insertBefore(analysisDisplay, contentDiv.firstChild);
                        resultsDiv.style.display = 'block';
                        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    // Enhanced AI Display Function - Part 2: General Analysis (No Nutrition Info)
                    function generateGeneralAnalysisHTML(analysisData, filename, imageData, timestamp) {
                        const analysisText = analysisData.raw_analysis || analysisData.analysis || JSON.stringify(analysisData, null, 2);
                        const isNoNutritionFound = /no nutritional information|no nutrition|not a food label|no food label/i.test(analysisText);
                        
                        return `
                            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
                                <!-- Header Section -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="background: ${isNoNutritionFound ? 'linear-gradient(135deg, #f39c12, #e67e22)' : 'linear-gradient(135deg, #3498db, #2980b9)'}; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                                            ${isNoNutritionFound ? 'üîç' : 'ü§ñ'}
                                        </div>
                                        <div>
                                            <h3 style="margin: 0; color: ${isNoNutritionFound ? '#f39c12' : '#3498db'}; font-size: 1.5rem; font-weight: 600;">
                                                ${isNoNutritionFound ? 'Image Analysis Complete' : 'AI Analysis Complete'}
                                            </h3>
                                            <p style="margin: 0; opacity: 0.8; font-size: 0.95rem;">
                                                ${isNoNutritionFound ? 'No nutrition label detected' : 'Analysis results available'}
                                            </p>
                                        </div>
                                    </div>
                                    <span style="background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; font-size: 12px; opacity: 0.8; font-weight: 500;">${timestamp}</span>
                                </div>

                                <!-- Main Content Grid -->
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px;">
                                    <!-- Image Section -->
                                    <div style="background: rgba(255, 255, 255, 0.1); padding: 18px; border-radius: 15px; text-align: center; border: 2px solid rgba(255,255,255,0.1);">
                                        <img src="${imageData}" style="width: 100%; max-height: 170px; object-fit: contain; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2);">
                                        <div style="font-size: 13px; opacity: 0.8; font-weight: 500; background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 15px;">${filename || 'Uploaded Image'}</div>
                                    </div>

                                    <!-- Analysis Content -->
                                    <div style="display: flex; flex-direction: column; gap: 18px;">
                                        ${generateAnalysisResultSection(analysisText, isNoNutritionFound)}
                                    </div>
                                </div>

                                ${generateGeneralActionButtonsSection(isNoNutritionFound)}
                            </div>
                        `;
                    }

                    function generateAnalysisResultSection(analysisText, isNoNutritionFound) {
                        if (isNoNutritionFound) {
                            return `
                                <div style="background: rgba(255,255,255,0.08); padding: 20px; border-radius: 12px; border-left: 4px solid #f39c12;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-weight: bold; color: #f39c12;">
                                        <span style="font-size: 18px;">üîç</span> 
                                        <span>Analysis Results</span>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 10px; border: 1px dashed rgba(255,255,255,0.2);">
                                        <div style="text-align: center; margin-bottom: 15px;">
                                            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                            <h4 style="margin: 0 0 10px 0; color: #f39c12;">No Nutrition Label Detected</h4>
                                            <p style="margin: 0; opacity: 0.8; line-height: 1.6;">
                                                This image doesn't appear to contain a nutrition facts label or food packaging with nutritional information.
                                            </p>
                                        </div>
                                        
                                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                            <h5 style="margin: 0 0 10px 0; color: #fff; font-size: 14px;">AI Analysis:</h5>
                                            <p style="margin: 0; font-size: 13px; line-height: 1.6; opacity: 0.9; font-style: italic;">
                                                "${analysisText}"
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div style="background: rgba(255,255,255,0.08); padding: 20px; border-radius: 12px; border-left: 4px solid #3498db;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-weight: bold; color: #3498db;">
                                        <span style="font-size: 18px;">üìã</span> 
                                        <span>Analysis Results</span>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; line-height: 1.8; font-size: 14px; color: rgba(255,255,255,0.9);">
                                        ${analysisText}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    function generateGeneralActionButtonsSection(isNoNutritionFound) {
                        if (isNoNutritionFound) {
                            return `
                                <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; text-align: center;">
                                    <div style="margin-bottom: 20px;">
                                        <div style="background: linear-gradient(135deg, #95a5a6, #7f8c8d); padding: 15px 25px; border-radius: 30px; display: inline-flex; align-items: center; gap: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2);">
                                            <span style="font-size: 24px;">‚ùì</span>
                                            <div>
                                                <div style="font-weight: bold; font-size: 18px; color: white;">No Nutrition Data</div>
                                                <div style="font-size: 12px; opacity: 0.9; color: white;">Try a food label image</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                                        <button onclick="document.getElementById('aiImageInput').click()" 
                                                style="background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; padding: 14px 28px; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px;"
                                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                                            <span style="font-size: 16px;">üì∑</span> 
                                            <span>Try Another Image</span>
                                        </button>
                                        
                                        <a href="nutrition-analysis.html" 
                                        style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 14px 28px; border-radius: 25px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                                            <span style="font-size: 16px;">üìä</span> 
                                            <span>View All Analyses</span>
                                        </a>
                                    </div>
                                    
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; font-size: 13px; opacity: 0.8;">
                                        <div style="margin-bottom: 8px; font-weight: bold;">üí° For nutrition tracking, upload:
                                            ‚Ä¢ Clear photos of nutrition facts labels
                                            ‚Ä¢ Food packaging with visible nutritional information
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; text-align: center;">
                                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                        <a href="nutrition-analysis.html" 
                                        style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 14px 28px; border-radius: 25px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
                                            <span style="font-size: 16px;">üìä</span> 
                                            <span>View All Analyses</span>
                                        </a>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    // Enhanced AI Display Function - Part 3: Nutrition Analysis (With Nutrition Info)
                    function generateNutritionAnalysisHTML(analysisData, calories, filename, imageData, timestamp, foodName) {
                        const nutritionFacts = extractNutritionFacts(analysisData);
                        const productInfo = extractProductInfo(analysisData);
                        const healthInsights = extractHealthInsights(analysisData);
                        
                        return `
                            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);">
                                <!-- Header Section -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="background: linear-gradient(135deg, #2ecc71, #27ae60); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);">üçé</div>
                                        <div>
                                            <h3 style="margin: 0; color: #2ecc71; font-size: 1.5rem; font-weight: 600;">Nutrition Analysis Complete</h3>
                                            <p style="margin: 0; opacity: 0.8; font-size: 0.95rem;">${productInfo.name || 'Food Item Analyzed'}</p>
                                        </div>
                                    </div>
                                    <span style="background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; font-size: 12px; opacity: 0.8; font-weight: 500;">${timestamp}</span>
                                </div>

                                <!-- Main Content Grid -->
                                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px;">
                                    <!-- Image Section -->
                                    <div style="background: rgba(255, 255, 255, 0.1); padding: 18px; border-radius: 15px; text-align: center; border: 2px solid rgba(255,255,255,0.1);">
                                        <img src="${imageData}" style="width: 100%; max-height: 170px; object-fit: contain; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2);">
                                        <div style="font-size: 13px; opacity: 0.8; font-weight: 500; background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 15px;">${filename || 'Uploaded Image'}</div>
                                    </div>

                                    <!-- Analysis Content -->
                                    <div style="display: flex; flex-direction: column; gap: 18px;">
                                        ${generateNutritionFactsSection(nutritionFacts, calories)}
                                    </div>
                                </div>

                                ${generateHealthInsightsSection(healthInsights)}
                                ${generateNutritionActionButtonsSection(calories, foodName)}
                            </div>
                        `;
                    }

                    function generateProductInfoSection(productInfo) {
                        // Product information section removed as requested
                        return '';
                    }

                    function generateNutritionFactsSection(nutritionFacts, calories) {
                        // Ensure we have a calories value in the facts
                        const caloriesValue = parseInt(calories) || nutritionFacts.calories || 0;
                        nutritionFacts.calories = caloriesValue;
                        
                        const facts = Object.entries(nutritionFacts).filter(([key, value]) => value !== null);
                        if (facts.length === 0) return '';
                        
                        return `
                            <div style="background: rgba(255,255,255,0.08); padding: 18px; border-radius: 12px; border-left: 4px solid #e74c3c;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 18px; font-weight: bold; color: #e74c3c;">
                                    <span style="font-size: 20px;">üçé</span> 
                                    <span style="font-size: 18px; font-weight: 600;">Key Nutrition Facts</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">
                                    ${facts.map(([key, value]) => `
                                        <div style="background: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08)); padding: 15px; border-radius: 12px; text-align: center; transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1);" 
                                            onmouseover="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.12))'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.2)'" 
                                            onmouseout="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.08))'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                            <div style="font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                                ${value}${getUnitForNutrient(key)}
                                            </div>
                                            <div style="font-size: 12px; opacity: 0.8; text-transform: capitalize; font-weight: 600; letter-spacing: 0.5px;">
                                                ${formatNutrientName(key)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    function generateHealthInsightsSection(healthInsights) {
                        if (!healthInsights) return '';
                        
                        return `
                            <div style="background: rgba(255,255,255,0.08); padding: 22px; border-radius: 12px; border-left: 4px solid #f39c12; margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 18px; font-weight: bold; color: #f39c12;">
                                    <span style="font-size: 20px;">üí°</span> 
                                    <span style="font-size: 16px;">Health Insights</span>
                                </div>
                                <div style="background: rgba(255,255,255,0.05); padding: 18px; border-radius: 10px; line-height: 1.8; font-size: 14px; color: rgba(255,255,255,0.95); border: 1px solid rgba(255,255,255,0.1);">
                                    ${healthInsights}
                                </div>
                            </div>
                        `;
                    }

                    function generateNutritionActionButtonsSection(calories, foodName) {
                        // Ensure calories is a number
                        const caloriesNum = parseInt(calories) || 0;
                        
                        return `
                            <div style="background: rgba(255,255,255,0.05); padding: 28px; border-radius: 15px; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 25px;">
                                    <div style="background: ${caloriesNum > 0 ? 'linear-gradient(135deg, #2ecc71, #27ae60)' : 'linear-gradient(135deg, #95a5a6, #7f8c8d)'}; padding: 18px 30px; border-radius: 35px; display: flex; align-items: center; gap: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.1);">
                                        <span style="font-size: 28px;">${caloriesNum > 0 ? 'üî•' : '‚ùì'}</span>
                                        <div>
                                            <div style="font-weight: bold; font-size: 26px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${caloriesNum}</div>
                                            <div style="font-size: 13px; opacity: 0.9; color: white; font-weight: 500;">Calories</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 18px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                                    <button onclick="addToCalorieCounter(${caloriesNum}, '${foodName}')" 
                                            style="background: ${caloriesNum > 0 ? 'linear-gradient(135deg, #2ecc71, #27ae60)' : 'linear-gradient(135deg, #95a5a6, #7f8c8d)'}; 
                                                color: white; border: none; padding: 16px 32px; border-radius: 28px; 
                                                cursor: ${caloriesNum > 0 ? 'pointer' : 'not-allowed'}; font-size: 15px; font-weight: bold; 
                                                box-shadow: 0 6px 20px rgba(0,0,0,0.2); transition: all 0.3s ease;
                                                display: inline-flex; align-items: center; gap: 10px; border: 2px solid rgba(255,255,255,0.1);" 
                                            ${caloriesNum <= 0 ? 'disabled' : ''}
                                            onmouseover="if(!this.disabled) { this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.3)'; }"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)';">
                                        <span style="font-size: 18px;">‚ûï</span> 
                                        <span>Add ${caloriesNum} Calories</span>
                                    </button>
                                    
                                    <a href="nutrition-analysis.html" 
                                    style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; 
                                            padding: 16px 32px; border-radius: 28px; text-decoration: none; font-weight: bold; 
                                            display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                                            transition: all 0.3s ease; border: 2px solid rgba(255,255,255,0.1); font-size: 15px;"
                                    onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(0,0,0,0.3)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)'">
                                        <span style="font-size: 18px;">üìä</span> 
                                        <span>View All Analyses</span>
                                    </a>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; font-size: 13px; opacity: 0.8; border: 1px solid rgba(255,255,255,0.1);">
                                    <span style="font-size: 16px; margin-right: 8px;">üí°</span>
                                    <strong>Tip:</strong> Click "Add Calories" to include this in your daily nutrition tracking!
                                </div>
                            </div>
                        `;
                    }
                    // Enhanced AI Display Function - Part 4: Helper Functions
                    function extractProductInfo(analysisData) {
                        return {
                            name: analysisData.product_name || analysisData.name || null,
                            brand: analysisData.brand || null,
                            servingSize: analysisData.serving_size || analysisData.servingSize || null,
                            ingredients: analysisData.ingredients || null,
                            allergens: analysisData.allergens || null
                        };
                    }

                    function extractNutritionFacts(analysisData) {
                        return {
                            calories: extractNumericValue(analysisData.calories),
                            totalFat: extractNumericValue(analysisData.total_fat || analysisData.fat),
                            saturatedFat: extractNumericValue(analysisData.saturated_fat),
                            cholesterol: extractNumericValue(analysisData.cholesterol),
                            sodium: extractNumericValue(analysisData.sodium),
                            totalCarbs: extractNumericValue(analysisData.total_carbs || analysisData.carbs),
                            dietaryFiber: extractNumericValue(analysisData.dietary_fiber || analysisData.fiber),
                            sugars: extractNumericValue(analysisData.sugars || analysisData.sugar),
                            protein: extractNumericValue(analysisData.protein)
                        };
                    }
                    
                    function extractNumericValue(value) {
                        if (!value) return null;
                        if (typeof value === 'number') return value;
                        const match = String(value).match(/(\d+(?:\.\d+)?)/);
                        return match ? parseFloat(match[1]) : null;
                    }

                    function extractHealthInsights(analysisData) {
                        return analysisData.analysis || analysisData.health_insights || analysisData.insights || null;
                    }

                    function extractNumericValue(value) {
                        if (!value) return null;
                        const match = String(value).match(/(\d+(?:\.\d+)?)/);
                        return match ? parseFloat(match[1]) : null;
                    }

                    function getUnitForNutrient(nutrient) {
                        const units = {
                            calories: '',
                            totalFat: 'g',
                            saturatedFat: 'g',
                            cholesterol: 'mg',
                            sodium: 'mg',
                            totalCarbs: 'g',
                            dietaryFiber: 'g',
                            sugars: 'g',
                            protein: 'g'
                        };
                        return units[nutrient] || '';
                    }

                    function formatNutrientName(nutrient) {
                        const names = {
                            totalFat: 'Total Fat',
                            saturatedFat: 'Saturated Fat',
                            totalCarbs: 'Total Carbs',
                            dietaryFiber: 'Dietary Fiber'
                        };
                        return names[nutrient] || nutrient.replace(/([A-Z])/g, ' $1').trim();
                    }
                    // Complete Enhanced Display Functions Created

                    
                    // Add calories to tracker function
                    window.addToCalorieCounter = function(calories, foodName) {
                        if (calories <= 0) {
                            alert('No calories detected to add!');
                            return;
                        }
                        
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                        const dailyGoal = parseInt(localStorage.getItem(`dailyCalorieGoal_${userId}`) || '2000');
                        const newTotal = currentConsumed + calories;
                        
                        localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
                        
                        const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                        foodEntries.push({
                            userId: userId,
                            calories: calories,
                            name: foodName,
                            timestamp: new Date().toISOString(),
                            source: 'ai_analysis'
                        });
                        localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
                        
                        // Update the calorie display immediately
                        updateCalorieDisplay(dailyGoal, newTotal);
                        
                        // Update button to show success
                        event.target.textContent = `Added ${calories} calories ‚úì`;
                        event.target.style.background = '#27ae60';
                        event.target.disabled = true;
                        
                        // Check if goal is reached
                        if (currentConsumed < dailyGoal && newTotal >= dailyGoal) {
                            showCalorieGoalCelebration();
                        }
                        
                        // Show success message
                        alert(`Added ${calories} calories to your daily tracker!`);
                    };
                    
                    // Goal celebration function
                    function showGoalCelebration(buttonElement) {
                        // Create confetti
                        createConfetti();
                        
                        // Create rabbit animation
                        const rabbit = document.createElement('div');
                        rabbit.innerHTML = 'üê∞';
                        rabbit.style.cssText = `
                            position: absolute;
                            font-size: 3rem;
                            z-index: 1000;
                            animation: rabbitHop 2s ease-in-out;
                            pointer-events: none;
                        `;
                        
                        // Position rabbit near the button
                        const rect = buttonElement.getBoundingClientRect();
                        rabbit.style.left = (rect.right + 20) + 'px';
                        rabbit.style.top = (rect.top - 20) + 'px';
                        
                        document.body.appendChild(rabbit);
                        
                        // Add CSS animation
                        if (!document.getElementById('celebrationStyles')) {
                            const style = document.createElement('style');
                            style.id = 'celebrationStyles';
                            style.textContent = `
                                @keyframes rabbitHop {
                                    0%, 100% { transform: translateY(0) rotate(0deg); }
                                    25% { transform: translateY(-30px) rotate(-10deg); }
                                    50% { transform: translateY(-50px) rotate(0deg); }
                                    75% { transform: translateY(-30px) rotate(10deg); }
                                }
                                .confetti {
                                    position: fixed;
                                    width: 10px;
                                    height: 10px;
                                    background: #f39c12;
                                    animation: confettiFall 3s linear forwards;
                                    pointer-events: none;
                                    z-index: 999;
                                }
                                @keyframes confettiFall {
                                    0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
                                    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        // Remove rabbit after animation
                        setTimeout(() => {
                            if (rabbit.parentNode) {
                                rabbit.parentNode.removeChild(rabbit);
                            }
                        }, 2000);
                    }
                    
                    // Create confetti function
                    function createConfetti() {
                        const colors = ['#f39c12', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#e67e22'];
                        
                        for (let i = 0; i < 50; i++) {
                            setTimeout(() => {
                                const confetti = document.createElement('div');
                                confetti.className = 'confetti';
                                confetti.style.left = Math.random() * 100 + 'vw';
                                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                                confetti.style.animationDelay = Math.random() * 2 + 's';
                                
                                document.body.appendChild(confetti);
                                
                                // Remove confetti after animation
                                setTimeout(() => {
                                    if (confetti.parentNode) {
                                        confetti.parentNode.removeChild(confetti);
                                    }
                                }, 3000);
                            }, i * 50);
                        }
                    }
                    
                    function saveAIAnalysisToStorage(file, result) {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            const analysis = result.analysis;
                            const caloriesMatch = analysis.match(/calories?[:\s]+(\d+)/i);
                            const calories = caloriesMatch ? parseInt(caloriesMatch[1]) : 0;
                            
                            const proteinMatch = analysis.match(/protein[:\s]+(\d+)[-‚Äì]?(\d+)?\s*g/i);
                            const carbsMatch = analysis.match(/carbohydrate[s]?[:\s]+(\d+)[-‚Äì]?(\d+)?\s*g/i);
                            const fatsMatch = analysis.match(/fat[s]?[:\s]+(\d+)[-‚Äì]?(\d+)?\s*g/i);
                            const fiberMatch = analysis.match(/fiber[:\s]+(\d+)[-‚Äì]?(\d+)?\s*g/i);
                            const sugarMatch = analysis.match(/sugar[s]?[:\s]+(\d+)[-‚Äì]?(\d+)?\s*g/i);
                            const sodiumMatch = analysis.match(/sodium[:\s]+(\d+)[-‚Äì]?(\d+)?\s*(mg|milligram)/i);
                            
                            const nutrition = {
                                calories: calories,
                                protein: proteinMatch ? parseInt(proteinMatch[1]) : Math.floor(calories * 0.15 / 4),
                                carbs: carbsMatch ? parseInt(carbsMatch[1]) : Math.floor(calories * 0.55 / 4),
                                fats: fatsMatch ? parseInt(fatsMatch[1]) : Math.floor(calories * 0.30 / 9),
                                fiber: fiberMatch ? parseInt(fiberMatch[1]) : Math.max(2, Math.floor(calories / 100)),
                                sugar: sugarMatch ? parseInt(sugarMatch[1]) : Math.floor(calories * 0.15 / 4),
                                sodium: sodiumMatch ? parseInt(sodiumMatch[1]) : Math.floor(calories * 2),
                                vitamins: 'A, C, Iron'
                            };
                            
                            try {
                                const base64 = e.target.result.split(',')[1];
                                const s3Response = await fetch('https://008zc5o3r8.execute-api.eu-north-1.amazonaws.com/Prod/upload-image', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        imageBase64: base64,
                                        fileType: file.type,
                                        userId: userId
                                    })
                                });
                                
                                const s3Data = await s3Response.json();
                                
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                img.onload = function() {
                                    canvas.width = Math.min(400, img.width);
                                    canvas.height = (canvas.width / img.width) * img.height;
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                                    
                                    const aiAnalysisEntry = {
                                        imageId: 'ai_analysis_' + Date.now(),
                                        userId: userId,
                                        imageUrl: s3Data.imageUrl,
                                        imageData: compressedImage,
                                        filename: file.name,
                                        filesize: file.size,
                                        fileType: file.type,
                                        uploadDate: new Date().toISOString(),
                                        aiAnalysis: result.analysis,
                                        nutrition: nutrition,
                                        calories: calories,
                                        foodName: file.name.replace(/\.[^/.]+$/, ""),
                                        type: 'ai_analysis',
                                        isAIAnalyzed: true
                                    };
                                    
                                    let aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                                    aiAnalysisEntries.push(aiAnalysisEntry);
                                    localStorage.setItem('aiAnalysisEntries', JSON.stringify(aiAnalysisEntries));
                                };
                                img.src = e.target.result;
                                
                                showAIUploadStatus(`‚úÖ Analyzed & uploaded to S3! <a href="nutrition-analysis.html" style="color: white; text-decoration: underline;">View Analysis</a> | <a href="user_dashboard.html" style="color: white; text-decoration: underline;">Dashboard</a>`, 'success');
                                
                            } catch (s3Error) {
                                console.error('S3 upload failed:', s3Error);
                                
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = new Image();
                                img.onload = function() {
                                    canvas.width = Math.min(400, img.width);
                                    canvas.height = (canvas.width / img.width) * img.height;
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    const compressedImage = canvas.toDataURL('image/jpeg', 0.7);
                                    
                                    const aiAnalysisEntry = {
                                        imageId: 'ai_analysis_' + Date.now(),
                                        userId: userId,
                                        imageData: compressedImage,
                                        filename: file.name,
                                        filesize: file.size,
                                        fileType: file.type,
                                        uploadDate: new Date().toISOString(),
                                        aiAnalysis: result.analysis,
                                        nutrition: nutrition,
                                        calories: calories,
                                        foodName: file.name.replace(/\.[^/.]+$/, ""),
                                        type: 'ai_analysis',
                                        isAIAnalyzed: true
                                    };
                                    
                                    let aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                                    aiAnalysisEntries.push(aiAnalysisEntry);
                                    localStorage.setItem('aiAnalysisEntries', JSON.stringify(aiAnalysisEntries));
                                };
                                img.src = e.target.result;
                                
                                showAIUploadStatus(`‚úÖ Analysis saved locally! (S3 upload failed) <a href="nutrition-analysis.html" style="color: white; text-decoration: underline;">View Analysis</a>`, 'success');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    window.addToCalorieCounter = function(calories, foodName) {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                        const newTotal = currentConsumed + calories;
                        localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
                        
                        const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                        foodEntries.push({
                            userId: userId,
                            calories: calories,
                            name: foodName,
                            timestamp: new Date().toISOString(),
                            source: 'ai_analysis'
                        });
                        localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
                        
                        showAIUploadStatus(`‚úÖ Added ${calories} calories to your tracker!`, 'success');
                        
                        event.target.textContent = 'Added ‚úì';
                        event.target.style.background = '#27ae60';
                        event.target.disabled = true;
                    };
                    

                    
                    function showStatus(message, isError = false) {
                        const statusDiv = document.getElementById('status-message') || document.createElement('div');
                        statusDiv.id = 'status-message';
                        statusDiv.style.marginTop = '10px';
                        statusDiv.style.padding = '8px';
                        statusDiv.style.borderRadius = '4px';
                        statusDiv.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
                        statusDiv.style.color = isError ? '#c62828' : '#2e7d32';
                        statusDiv.innerHTML = message;
                        
                        if (!document.getElementById('status-message')) {
                            dropArea.parentNode.insertBefore(statusDiv, dropArea.nextSibling);
                        }
                        
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 5000);
                    }
                    
                    // Food browser and search functionality
                    function setupFoodBrowser() {
                        const foodNameInput = document.getElementById('foodNameInput');
                        const resultsDiv = document.getElementById('searchResults');
                        const caloriesInput = document.getElementById('caloriesInput');
                        const selectedFood = document.getElementById('selectedFood');
                        const selectedFoodImg = document.getElementById('selectedFoodImg');
                        const selectedFoodName = document.getElementById('selectedFoodName');
                        const selectedFoodCalories = document.getElementById('selectedFoodCalories');
                        
                        // Tab switching functionality
                        const tabs = document.querySelectorAll('.food-tab');
                        tabs.forEach(tab => {
                            tab.addEventListener('click', function() {
                                // Remove active class from all tabs
                                tabs.forEach(t => {
                                    t.classList.remove('active');
                                    t.style.borderBottom = '2px solid transparent';
                                });
                                
                                // Add active class to clicked tab
                                this.classList.add('active');
                                this.style.borderBottom = '2px solid #3498db';
                                
                                // Hide all tab contents
                                document.querySelectorAll('.tab-content').forEach(content => {
                                    content.style.display = 'none';
                                });
                                
                                // Show selected tab content
                                const tabId = this.id.replace('Tab', 'TabContent');
                                document.getElementById(tabId).style.display = 'block';
                                
                                // Show/hide Add Calories button based on tab
                                const submitBtn = document.getElementById('submitCaloriesBtn');
                                if (this.id === 'fruitsTab' || this.id === 'vegetablesTab') {
                                    submitBtn.style.display = 'none';
                                } else {
                                    submitBtn.style.display = 'block';
                                }
                            });
                        });
                        
                        // Populate fruits and vegetables lists
                        populateFoodCategory('fruits', 'fruitsList');
                        populateFoodCategory('vegetables', 'vegetablesList');
                        
                        // Search functionality
                        if (foodNameInput && resultsDiv) {
                            foodNameInput.addEventListener('input', function() {
                                const query = this.value.trim();
                                if (query.length < 2) {
                                    resultsDiv.style.display = 'none';
                                    return;
                                }
                                
                                const results = searchFood(query);
                                if (results.length > 0) {
                                    resultsDiv.innerHTML = '';
                                    results.forEach(food => {
                                        const item = document.createElement('div');
                                        item.style.padding = '8px 12px';
                                        item.style.cursor = 'pointer';
                                        item.style.borderBottom = '1px solid #eee';
                                        
                                        // Always use emoji if available, otherwise use image with emoji fallback
                                        let imageContent;
                                        if (food.emoji) {
                                            imageContent = `<div style="font-size: 24px; margin-right: 8px;">${food.emoji}</div>`;
                                        } else if (food.image) {
                                            imageContent = `
                                                <img src="${food.image}" alt="${food.name}" style="width: 24px; height: 24px; margin-right: 8px;" 
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                <div style="font-size: 24px; margin-right: 8px; display: none;">üçΩÔ∏è</div>
                                            `;
                                        } else {
                                            imageContent = `<div style="font-size: 24px; margin-right: 8px;">üçΩÔ∏è</div>`;
                                        }
                                        
                                        item.innerHTML = `
                                            <div style="display: flex; align-items: center;">
                                                ${imageContent}
                                                <div>
                                                    <strong>${food.name}</strong> (${food.calories} cal)
                                                </div>
                                            </div>
                                        `;
                                        
                                        item.addEventListener('mouseenter', () => {
                                            item.style.backgroundColor = '#f0f0f0';
                                        });
                                        
                                        item.addEventListener('mouseleave', () => {
                                            item.style.backgroundColor = 'transparent';
                                        });
                                        
                                        item.addEventListener('click', () => {
                                            selectFood(food);
                                            resultsDiv.style.display = 'none';
                                        });
                                        
                                        resultsDiv.appendChild(item);
                                    });
                                    resultsDiv.style.display = 'block';
                                } else {
                                    resultsDiv.style.display = 'none';
                                }
                            });
                            
                            // Hide results when clicking outside
                            document.addEventListener('click', function(e) {
                                if (e.target !== foodNameInput && e.target !== resultsDiv) {
                                    resultsDiv.style.display = 'none';
                                }
                            });
                        }
                        
                        // Function to populate a food category
                        function populateFoodCategory(category, containerId) {
                            const container = document.getElementById(containerId);
                            if (!container) return;
                            
                            const foods = getFoodsByCategory(category);
                            container.innerHTML = '';
                            
                            foods.forEach(food => {
                                const foodCard = document.createElement('div');
                                foodCard.style.display = 'flex';
                                foodCard.style.flexDirection = 'column';
                                foodCard.style.alignItems = 'center';
                                foodCard.style.padding = '10px';
                                foodCard.style.backgroundColor = '#f8f9fa';
                                foodCard.style.borderRadius = '8px';
                                foodCard.style.cursor = 'pointer';
                                foodCard.style.transition = 'transform 0.2s';
                                
                                // Always use emoji if available, otherwise use image with emoji fallback
                                let imageContent;
                                if (food.emoji) {
                                    imageContent = `<div style="font-size: 40px; margin-bottom: 5px;">${food.emoji}</div>`;
                                } else if (food.image) {
                                    imageContent = `
                                        <img src="${food.image}" alt="${food.name}" style="width: 50px; height: 50px; margin-bottom: 5px;" 
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="font-size: 40px; margin-bottom: 5px; display: none;">üçΩÔ∏è</div>
                                    `;
                                } else {
                                    imageContent = `<div style="font-size: 40px; margin-bottom: 5px;">üçΩÔ∏è</div>`;
                                }
                                
                                foodCard.innerHTML = `
                                    ${imageContent}
                                    <div style="font-size: 12px; text-align: center; font-weight: bold;">${food.name}</div>
                                    <div style="font-size: 11px; color: #666;">${food.calories} cal</div>
                                `;
                                
                                foodCard.addEventListener('mouseenter', () => {
                                    foodCard.style.transform = 'translateY(-3px)';
                                    foodCard.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                                });
                                
                                foodCard.addEventListener('mouseleave', () => {
                                    foodCard.style.transform = 'translateY(0)';
                                    foodCard.style.boxShadow = 'none';
                                });
                                
                                foodCard.addEventListener('click', () => {
                                    // Add calories directly
                                    addCaloriesToTracker(food.calories, food.name);
                                    
                                    // Add emoji to background
                                    if (food.emoji) {
                                        addFloatingEmoji(food.emoji);
                                    }
                                    
                                    // Show tick animation
                                    showAddedTick(foodCard);
                                });
                                
                                container.appendChild(foodCard);
                            });
                        }
                        
                        // Function to select a food
                        function selectFood(food) {
                            foodNameInput.value = food.name;
                            caloriesInput.value = food.calories;
                            
                            // Update selected food display
                            if (selectedFood && selectedFoodImg && selectedFoodName && selectedFoodCalories) {
                                const selectedFoodEmoji = document.getElementById('selectedFoodEmoji');
                                
                                // Use emoji if available, otherwise use image
                                if (food.emoji) {
                                    selectedFoodImg.style.display = 'none';
                                    selectedFoodEmoji.style.display = 'block';
                                    selectedFoodEmoji.textContent = food.emoji;
                                    
                                    // Add an "Add to Background" button
                                    const addToBackgroundBtn = document.createElement('button');
                                    addToBackgroundBtn.textContent = 'Add to Background';
                                    addToBackgroundBtn.style.marginTop = '10px';
                                    addToBackgroundBtn.style.padding = '5px 10px';
                                    addToBackgroundBtn.style.backgroundColor = '#3498db';
                                    addToBackgroundBtn.style.color = 'white';
                                    addToBackgroundBtn.style.border = 'none';
                                    addToBackgroundBtn.style.borderRadius = '4px';
                                    addToBackgroundBtn.style.cursor = 'pointer';
                                    
                                    // Remove any existing button first
                                    const existingBtn = document.getElementById('addToBackgroundBtn');
                                    if (existingBtn) {
                                        existingBtn.remove();
                                    }
                                    
                                    addToBackgroundBtn.id = 'addToBackgroundBtn';
                                    addToBackgroundBtn.addEventListener('click', function() {
                                        addFloatingEmoji(food.emoji);
                                        this.textContent = 'Added!';
                                        this.style.backgroundColor = '#2ecc71';
                                        setTimeout(() => {
                                            this.textContent = 'Add to Background';
                                            this.style.backgroundColor = '#3498db';
                                        }, 1500);
                                    });
                                    
                                    selectedFood.appendChild(addToBackgroundBtn);
                                } else if (food.image) {
                                    selectedFoodImg.style.display = 'block';
                                    selectedFoodEmoji.style.display = 'none';
                                    selectedFoodImg.src = food.image;
                                    
                                    // Remove any existing button
                                    const existingBtn = document.getElementById('addToBackgroundBtn');
                                    if (existingBtn) {
                                        existingBtn.remove();
                                    }
                                } else {
                                    // Default food icon
                                    selectedFoodImg.style.display = 'block';
                                    selectedFoodEmoji.style.display = 'none';
                                    selectedFoodImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzMzMyI+PHBhdGggZD0iTTExIDlIOXYySDh2MmgxdjJoMnYtMmgxdi0yaC0xVjl6bTQgNGgtMXYyaC0ydi0ySDl2MmgxdjJoMnYtMmgxdjJoMnYtMmgxdi0yaC0xem0tNC01aDJ2MmgtMlY4em0xMC0zSDNjLTEuMSAwLTIgLjktMiAydjEyYzAgMS4xLjkgMiAyIDJoMThjMS4xIDAgMi0uOSAyLTJWN2MwLTEuMS0uOS0yLTItMnptMCAxNEgzVjdoMTh2MTJ6Ii8+PC9zdmc+';
                                    
                                    // Remove any existing button
                                    const existingBtn = document.getElementById('addToBackgroundBtn');
                                    if (existingBtn) {
                                        existingBtn.remove();
                                    }
                                }
                                
                                selectedFoodName.textContent = food.name;
                                selectedFoodCalories.textContent = `${food.calories} calories`;
                                selectedFood.style.display = 'block';
                            }
                        }
                        
                        // Load saved foods into dropdown
                        function loadSavedFoods() {
                            const savedFoodsSelect = document.getElementById('savedFoodsSelect');
                            if (!savedFoodsSelect) return;
                            
                            // Clear existing options except the first one
                            while (savedFoodsSelect.options.length > 1) {
                                savedFoodsSelect.remove(1);
                            }
                            
                            // Get saved foods from localStorage
                            const customFoods = JSON.parse(localStorage.getItem('customFoods') || '[]');
                            
                            // Add each food to the dropdown
                            customFoods.forEach(food => {
                                const option = document.createElement('option');
                                option.value = food.name;
                                option.textContent = `${food.name} (${food.calories} cal)`;
                                option.dataset.calories = food.calories;
                                savedFoodsSelect.appendChild(option);
                            });
                        }
                        
                        // Set up custom food functionality
                        const saveFoodBtn = document.getElementById('saveFoodBtn');
                        const loadSavedFoodBtn = document.getElementById('loadSavedFoodBtn');
                        const savedFoodMessage = document.getElementById('savedFoodMessage');
                        
                        if (saveFoodBtn) {
                            saveFoodBtn.addEventListener('click', function() {
                                const foodName = foodNameInput.value.trim();
                                const calories = parseInt(caloriesInput.value) || 0;
                                
                                if (!foodName || calories <= 0) {
                                    alert('Please enter both a food name and calorie amount');
                                    return;
                                }
                                
                                // Get existing custom foods
                                const customFoods = JSON.parse(localStorage.getItem('customFoods') || '[]');
                                
                                // Check if food already exists
                                const existingIndex = customFoods.findIndex(food => food.name.toLowerCase() === foodName.toLowerCase());
                                
                                if (existingIndex !== -1) {
                                    // Update existing food
                                    customFoods[existingIndex].calories = calories;
                                    savedFoodMessage.textContent = `Updated "${foodName}" in your saved foods`;
                                } else {
                                    // Add new food
                                    customFoods.push({
                                        name: foodName,
                                        calories: calories,
                                        emoji: 'üçΩÔ∏è' // Default emoji for custom foods
                                    });
                                    savedFoodMessage.textContent = `Added "${foodName}" to your saved foods`;
                                }
                                
                                // Save back to localStorage
                                localStorage.setItem('customFoods', JSON.stringify(customFoods));
                                
                                // Show success message
                                savedFoodMessage.style.display = 'block';
                                setTimeout(() => {
                                    savedFoodMessage.style.display = 'none';
                                }, 3000);
                                
                                // Reload saved foods dropdown
                                loadSavedFoods();
                            });
                        }
                        
                        if (loadSavedFoodBtn) {
                            loadSavedFoodBtn.addEventListener('click', function() {
                                const select = document.getElementById('savedFoodsSelect');
                                const selectedOption = select.options[select.selectedIndex];
                                
                                if (selectedOption && selectedOption.value) {
                                    foodNameInput.value = selectedOption.value;
                                    caloriesInput.value = selectedOption.dataset.calories;
                                }
                            });
                        }
                        
                        // Load saved foods on initialization
                        loadSavedFoods();
                    }
                    
                    // Function to show added tick animation
                    function showAddedTick(element) {
                        // Create tick element
                        const tick = document.createElement('div');
                        tick.innerHTML = '‚úì';
                        tick.style.position = 'absolute';
                        tick.style.top = '50%';
                        tick.style.left = '50%';
                        tick.style.transform = 'translate(-50%, -50%)';
                        tick.style.fontSize = '30px';
                        tick.style.color = '#2ecc71';
                        tick.style.fontWeight = 'bold';
                        tick.style.opacity = '0';
                        tick.style.transition = 'opacity 0.3s ease';
                        tick.style.pointerEvents = 'none';
                        tick.style.zIndex = '10';
                        
                        // Make parent relative if not already
                        element.style.position = 'relative';
                        element.appendChild(tick);
                        
                        // Animate in
                        setTimeout(() => {
                            tick.style.opacity = '1';
                        }, 10);
                        
                        // Remove after animation
                        setTimeout(() => {
                            tick.style.opacity = '0';
                            setTimeout(() => {
                                if (tick.parentNode) {
                                    tick.parentNode.removeChild(tick);
                                }
                            }, 300);
                        }, 1000);
                    }
                    
                    // Function to add calories to tracker
                    function addCaloriesToTracker(calories, foodName) {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        // Get current consumed calories
                        const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                        
                        // Add to today's total
                        const newTotal = currentConsumed + calories;
                        localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
                        
                        // Save food entry
                        const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                        foodEntries.push({
                            userId: userId,
                            calories: calories,
                            name: foodName || 'Unnamed food',
                            timestamp: new Date().toISOString()
                        });
                        localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
                        
                        // Update UI
                        const dailyGoal = parseInt(localStorage.getItem(`dailyCalorieGoal_${userId}`) || '2000');
                        updateCalorieDisplay(dailyGoal, newTotal);
                        updateCalorieChart();
                    }
                    
                    // Daily calorie tracking functionality
                    async function initializeCalorieTracker() {
                        // Get elements
                        const setDailyGoalBtn = document.getElementById('setDailyGoalBtn');
                        const addCaloriesBtn = document.getElementById('addCaloriesBtn');
                        const setGoalModal = document.getElementById('setGoalModal');
                        const addCaloriesModal = document.getElementById('addCaloriesModal');
                        const closeSetGoalBtn = document.getElementById('closeSetGoalBtn');
                        const closeAddCaloriesBtn = document.getElementById('closeAddCaloriesBtn');
                        const submitGoalBtn = document.getElementById('submitGoalBtn');
                        const submitCaloriesBtn = document.getElementById('submitCaloriesBtn');
                        
                        // Get current user ID
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        // Check if we need to reset daily tracking (per user)
                        const lastResetDate = localStorage.getItem(`lastCalorieResetDate_${userId}`);
                        const today = new Date().toDateString();
                        
                        if (lastResetDate !== today) {
                            // Reset daily tracking for this user
                            localStorage.setItem(`caloriesConsumedToday_${userId}`, '0');
                            localStorage.setItem(`lastCalorieResetDate_${userId}`, today);
                        }
                        
                        // Use local user data (API not deployed yet)
                        const latestUserData = JSON.parse(localStorage.getItem('userData') || '{}');
                        
                        // Load current values for this user
                        let dailyGoal = 2000; // Default
                        if (latestUserData.calorieGoal) {
                            dailyGoal = parseInt(latestUserData.calorieGoal);
                        } else {
                            // Fall back to stored goal or default
                            dailyGoal = parseInt(localStorage.getItem(`dailyCalorieGoal_${userId}`) || '2000');
                        }
                        
                        const caloriesConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                        
                        // Update UI
                        updateCalorieDisplay(dailyGoal, caloriesConsumed);
                        
                        // Set up event listeners
                        setDailyGoalBtn.addEventListener('click', function() {
                            document.getElementById('goalInput').value = dailyGoal;
                            setGoalModal.style.display = 'block';
                        });
                        
                        addCaloriesBtn.addEventListener('click', function() {
                            document.getElementById('caloriesInput').value = '';
                            document.getElementById('foodNameInput').value = '';
                            addCaloriesModal.style.display = 'block';
                        });
                        
                        closeSetGoalBtn.addEventListener('click', function() {
                            setGoalModal.style.display = 'none';
                        });
                        
                        closeAddCaloriesBtn.addEventListener('click', function() {
                            addCaloriesModal.style.display = 'none';
                        });
                        
                        submitGoalBtn.addEventListener('click', async function() {
                            const newGoal = parseInt(document.getElementById('goalInput').value) || 2000;
                            
                            // Update user data locally (API not deployed yet)
                            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                            userData.calorieGoal = newGoal;
                            localStorage.setItem('userData', JSON.stringify(userData));
                            
                            // Store goal for this specific user (fallback)
                            localStorage.setItem(`dailyCalorieGoal_${userId}`, newGoal.toString());
                            updateCalorieDisplay(newGoal, caloriesConsumed);
                            setGoalModal.style.display = 'none';
                        });
                        
                        submitCaloriesBtn.addEventListener('click', function() {
                            const calories = parseInt(document.getElementById('caloriesInput').value) || 0;
                            const foodName = document.getElementById('foodNameInput').value;
                            
                            if (calories <= 0) {
                                alert('Please enter a valid calorie amount');
                                return;
                            }
                            
                            // Get current user ID (again to ensure it's the latest)
                            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                            const userId = userData.userId || 'guest';
                            
                            // Get current consumed calories
                            const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                            
                            // Add to today's total for this specific user
                            const newTotal = currentConsumed + calories;
                            localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
                            
                            // Get nutrition info if available
                            let nutritionInfo = null;
                            const foodKey = foodName.toLowerCase();
                            
                            try {
                                // Check built-in database first
                                if (window.nutritionDB && nutritionDB[foodKey]) {
                                    nutritionInfo = nutritionDB[foodKey];
                                } else {
                                    // Check custom foods
                                    const customFoods = JSON.parse(localStorage.getItem('customFoods') || '[]');
                                    const customFood = customFoods.find(food => food.name && food.name.toLowerCase() === foodKey);
                                    if (customFood) {
                                        nutritionInfo = customFood;
                                    }
                                }
                            } catch (e) {
                                console.error('Error getting nutrition info:', e);
                            }
                            
                            // Save food entry with user ID
                            const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                            foodEntries.push({
                                userId: userId, // Add user ID to each food entry
                                calories: calories,
                                name: foodName || 'Unnamed food',
                                timestamp: new Date().toISOString(),
                                nutritionInfo: nutritionInfo,
                                isCustom: nutritionInfo && !window.nutritionDB?.[foodKey]
                            });
                            
                            console.log(`Adding food entry for user ${userId}: ${foodName} (${calories} calories)`);
                            
                            // Check if the food has an emoji and add it to the floating background
                            if (nutritionInfo && nutritionInfo.emoji) {
                                addFloatingEmoji(nutritionInfo.emoji);
                            } else if (foodName) {
                                // Try to find a matching emoji for common fruits and vegetables
                                const foodEmojis = {
                                    'apple': 'üçé', 'banana': 'üçå', 'orange': 'üçä', 'strawberry': 'üçì',
                                    'grapes': 'üçá', 'watermelon': 'üçâ', 'pear': 'üçê', 'peach': 'üçë',
                                    'cherry': 'üçí', 'mango': 'ü•≠', 'pineapple': 'üçç', 'coconut': 'ü••',
                                    'kiwi': 'ü•ù', 'avocado': 'ü•ë', 'eggplant': 'üçÜ', 'potato': 'ü•î',
                                    'carrot': 'ü•ï', 'corn': 'üåΩ', 'cucumber': 'ü•í', 'broccoli': 'ü•¶',
                                    'garlic': 'üßÑ', 'onion': 'üßÖ', 'mushroom': 'üçÑ', 'pepper': 'üå∂Ô∏è',
                                    'tomato': 'üçÖ', 'olive': 'ü´í', 'salad': 'ü•ó', 'bread': 'üçû',
                                    'cheese': 'üßÄ', 'egg': 'ü•ö', 'meat': 'üçñ', 'chicken': 'üçó',
                                    'bacon': 'ü•ì', 'hamburger': 'üçî', 'pizza': 'üçï', 'hotdog': 'üå≠',
                                    'sandwich': 'ü•™', 'taco': 'üåÆ', 'burrito': 'üåØ', 'rice': 'üçö',
                                    'spaghetti': 'üçù', 'sweet potato': 'üç†', 'sushi': 'üç£', 'fish': 'üêü',
                                    'cake': 'üç∞', 'cookie': 'üç™', 'chocolate': 'üç´', 'candy': 'üç¨',
                                    'ice cream': 'üç¶', 'donut': 'üç©', 'milk': 'ü•õ', 'coffee': '‚òï',
                                    'tea': 'üçµ', 'beer': 'üç∫', 'wine': 'üç∑', 'cocktail': 'üç∏'
                                };
                                
                                const lowerName = foodName.toLowerCase();
                                let emoji = null;
                                
                                // Check for exact matches
                                if (foodEmojis[lowerName]) {
                                    emoji = foodEmojis[lowerName];
                                } else {
                                    // Check for partial matches
                                    for (const [key, value] of Object.entries(foodEmojis)) {
                                        if (lowerName.includes(key)) {
                                            emoji = value;
                                            break;
                                        }
                                    }
                                }
                                
                                if (emoji) {
                                    addFloatingEmoji(emoji);
                                }
                            }
                            localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
                            
                            // Update UI with the new total
                            updateCalorieDisplay(dailyGoal, newTotal);
                            addCaloriesModal.style.display = 'none';
                            
                            // Update the calorie chart
                            updateCalorieChart();
                            
                            // Reset form fields
                            document.getElementById('caloriesInput').value = '';
                            document.getElementById('foodNameInput').value = '';
                            
                            // Clear selected food display
                            const selectedFood = document.getElementById('selectedFood');
                            if (selectedFood) {
                                selectedFood.style.display = 'none';
                            }
                        });
                    }
                    
                    function updateCalorieDisplay(goal, consumed) {
                        const previousPercentage = Math.min(100, Math.round((parseInt(document.getElementById('caloriesConsumed').textContent || '0') / goal) * 100));
                        
                        // Update text displays
                        document.getElementById('dailyCalorieGoal').textContent = goal;
                        document.getElementById('caloriesConsumed').textContent = consumed;
                        document.getElementById('caloriesRemaining').textContent = Math.max(0, goal - consumed);
                        
                        // Calculate percentage
                        const percentage = Math.min(100, Math.round((consumed / goal) * 100));
                        
                        // Update progress text
                        document.getElementById('progressText').textContent = 
                            `You have completed ${percentage}% of your calorie intake for the day.${percentage >= 100 ? ' You\'ve reached your goal!' : ''}`;
                        
                        // Update progress bar
                        document.getElementById('progressFill').style.width = `${percentage}%`;
                        
                        // Update circle progress
                        const circle = document.getElementById('progressCircle');
                        const circumference = 502; // 2 * PI * radius
                        const offset = circumference - (percentage / 100) * circumference;
                        circle.style.strokeDashoffset = offset;
                        
                        // Update percentage text
                        document.getElementById('progressPercent').textContent = `${percentage}%`;
                        
                        // Show celebration when goal is reached
                        if (previousPercentage < 100 && percentage >= 100) {
                            showCalorieGoalCelebration();
                        }
                    }
                    
                    // Function to update the calorie chart
                    function updateCalorieChart() {
                        // Get the last 7 days of calorie data
                        const calorieHistory = getCalorieHistory();
                        
                        // Update day labels with actual dates
                        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        const today = new Date();
                        
                        for (let i = 0; i < 7; i++) {
                            const date = new Date();
                            date.setDate(today.getDate() - (6 - i));
                            const dayOfWeek = days[date.getDay()];
                            document.getElementById(`day${i}`).textContent = dayOfWeek;
                        }
                        
                        // Find max calories for scaling
                        const maxCalories = Math.max(2000, ...calorieHistory.map(day => day.calories));
                        const yScale = 120 / maxCalories; // 140 (bottom) - 20 (top) = 120px range
                        
                        // Update Y-axis labels
                        document.getElementById('cal0').textContent = '0';
                        document.getElementById('cal1').textContent = Math.round(maxCalories / 3);
                        document.getElementById('cal2').textContent = Math.round(maxCalories * 2 / 3);
                        document.getElementById('cal3').textContent = maxCalories;
                        
                        // Generate points for the polyline
                        let points = '';
                        const dataPointsContainer = document.getElementById('dataPoints');
                        dataPointsContainer.innerHTML = '';
                        
                        calorieHistory.forEach((day, index) => {
                            const x = 20 + index * 40; // 7 points evenly spaced
                            const y = 140 - (day.calories * yScale); // Convert calories to y position
                            
                            points += `${x},${y} `;
                            
                            // Add data point circle
                            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            circle.setAttribute('cx', x);
                            circle.setAttribute('cy', y);
                            circle.setAttribute('r', '4');
                            circle.setAttribute('fill', index === 6 ? '#2980b9' : '#3498db');
                            
                            // Add tooltip with date and calories
                            const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                            title.textContent = `${day.date}: ${day.calories} calories`;
                            circle.appendChild(title);
                            
                            dataPointsContainer.appendChild(circle);
                        });
                        
                        // Update the polyline
                        document.getElementById('caloriePolyline').setAttribute('points', points);
                    }
                    
                    // Function to get calorie history for the last 7 days
                    function getCalorieHistory() {
                        const history = [];
                        const today = new Date();
                        today.setHours(0, 0, 0, 0); // Start of today
                        
                        // Get user ID for filtering
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId;
                        
                        // Get all food entries
                        const allFoodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                        
                        // Filter entries by user ID if available
                        const userEntries = userId ? 
                            allFoodEntries.filter(entry => entry.userId === userId) : 
                            allFoodEntries;
                        
                        // Create array for the last 7 days
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date();
                            date.setDate(today.getDate() - i);
                            date.setHours(0, 0, 0, 0);
                            
                            const nextDate = new Date(date);
                            nextDate.setDate(date.getDate() + 1);
                            
                            // Find entries for this day
                            const dayEntries = userEntries.filter(entry => {
                                const entryDate = new Date(entry.timestamp);
                                return entryDate >= date && entryDate < nextDate;
                            });
                            
                            // Sum calories for the day
                            const totalCalories = dayEntries.reduce((sum, entry) => sum + (entry.calories || 0), 0);
                            
                            // Format date as MM/DD
                            const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                            
                            history.push({
                                date: formattedDate,
                                calories: totalCalories
                            });
                        }
                        
                        return history;
                    }
                    
                    // Function to update breakdown cards with Bedrock data
                    function updateBreakdownCards() {
                        const aiAnalyses = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        // Get all analyses for this user and sum up the totals
                        const userAnalyses = aiAnalyses.filter(entry => entry.userId === userId && entry.hasNutritionInfo);
                        
                        const breakdownGrid = document.getElementById('breakdownGrid');
                        if (!breakdownGrid) return;
                        
                        let totalCarbsGrams = 0, totalProteinGrams = 0, totalFatGrams = 0;
                        
                        // Sum up all nutrition data from all analyses
                        userAnalyses.forEach(userAnalysis => {
                            if (userAnalysis && userAnalysis.analysis) {
                                let analysisData = userAnalysis.analysis;
                                let carbsGrams = 0, proteinGrams = 0, fatGrams = 0;
                                
                                // Try to parse as JSON first
                                if (typeof analysisData === 'string') {
                                    try {
                                        analysisData = JSON.parse(analysisData);
                                    } catch (e) {
                                        // If not JSON, keep as string for regex parsing
                                    }
                                }
                                
                                // Extract grams from JSON format
                                if (typeof analysisData === 'object' && analysisData !== null) {
                                    carbsGrams = parseFloat(analysisData.total_carbs?.replace('g', '') || analysisData.carbs?.replace('g', '') || 0);
                                    proteinGrams = parseFloat(analysisData.protein?.replace('g', '') || 0);
                                    fatGrams = parseFloat(analysisData.total_fat?.replace('g', '') || analysisData.fat?.replace('g', '') || 0);
                                } else {
                                    // Enhanced regex parsing for string format
                                    const analysis = String(analysisData);
                                    const fatGramsMatch = analysis.match(/(\d+(?:\.\d+)?)[\s]*g?[\s]*(?:Total Fat|Fat)/i);
                                    const carbsGramsMatch = analysis.match(/(\d+(?:\.\d+)?)[\s]*g?[\s]*(?:Total Carbohydrate|Total Carbs|Carbohydrate|Carbs)/i);
                                    const proteinGramsMatch = analysis.match(/(\d+(?:\.\d+)?)[\s]*g?[\s]*(?:Protein)/i);
                                    
                                    carbsGrams = carbsGramsMatch ? parseFloat(carbsGramsMatch[1]) : 0;
                                    proteinGrams = proteinGramsMatch ? parseFloat(proteinGramsMatch[1]) : 0;
                                    fatGrams = fatGramsMatch ? parseFloat(fatGramsMatch[1]) : 0;
                                    
                                    // If still no carbs found, try broader search
                                    if (carbsGrams === 0) {
                                        const broadCarbsMatch = analysis.match(/(\d+(?:\.\d+)?)[\s]*g?.*carb/i);
                                        carbsGrams = broadCarbsMatch ? parseFloat(broadCarbsMatch[1]) : 0;
                                    }
                                }
                                
                                // Debug logging
                                console.log('Analysis data:', analysisData);
                                console.log('Extracted carbs:', carbsGrams, 'protein:', proteinGrams, 'fat:', fatGrams);
                                
                                // Add to totals
                                totalCarbsGrams += carbsGrams;
                                totalProteinGrams += proteinGrams;
                                totalFatGrams += fatGrams;
                            }
                        });
                        
                        breakdownGrid.innerHTML = generateBreakdownCards(0, 0, 0, totalCarbsGrams, totalProteinGrams, totalFatGrams);
                    }
                    
                    function updateRecommendations() {
                        const aiAnalyses = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        const userAnalysis = aiAnalyses.find(entry => entry.userId === userId && entry.hasNutritionInfo);
                        const recommendationsList = document.getElementById('recommendationsList');
                        
                        if (!recommendationsList) return;
                        
                        if (userAnalysis && userAnalysis.analysis) {
                            const analysis = typeof userAnalysis.analysis === 'string' ? userAnalysis.analysis : JSON.stringify(userAnalysis.analysis);
                            
                            // Extract recommendations from Bedrock response
                            const recommendations = extractRecommendations(analysis);
                            
                            if (recommendations.length > 0) {
                                recommendationsList.innerHTML = recommendations.map(rec => `
                                    <div class="recommendation-item">
                                        <h3>${rec.title}</h3>
                                        <p>${rec.description}</p>
                                    </div>
                                `).join('');
                            } else {
                                recommendationsList.innerHTML = `
                                    <div class="recommendation-item">
                                        <h3>Upload a food label for personalized recommendations</h3>
                                        <p>Our AI will analyze your nutrition and provide tailored advice</p>
                                    </div>
                                `;
                            }
                        } else {
                            recommendationsList.innerHTML = `
                                <div class="recommendation-item">
                                    <h3>Upload a food label for personalized recommendations</h3>
                                    <p>Our AI will analyze your nutrition and provide tailored advice</p>
                                </div>
                            `;
                        }
                    }
                    
                    function extractRecommendations(analysis) {
                        const recommendations = [];
                        
                        // Try to parse as JSON first to get the analysis field
                        let analysisText = analysis;
                        try {
                            const parsed = JSON.parse(analysis);
                            analysisText = parsed.analysis || parsed.recommendations || analysis;
                        } catch (e) {
                            // If not JSON, use the raw text
                            analysisText = analysis;
                        }
                        
                        // Look for recommendation patterns in the analysis text
                        const recPattern = /recommend[s]?[^.!?]*[.!?]/gi;
                        const shouldPattern = /should[^.!?]*[.!?]/gi;
                        const considerPattern = /consider[^.!?]*[.!?]/gi;
                        const advicePattern = /advice[^.!?]*[.!?]/gi;
                        
                        const matches = [
                            ...analysisText.match(recPattern) || [],
                            ...analysisText.match(shouldPattern) || [],
                            ...analysisText.match(considerPattern) || [],
                            ...analysisText.match(advicePattern) || []
                        ];
                        
                        // If no specific recommendations found, extract meaningful sentences
                        if (matches.length === 0) {
                            const sentences = analysisText.split(/[.!?]+/)
                                .filter(s => s.trim().length > 20 && !s.includes('"') && !s.includes('{'))
                                .filter(s => !/^\s*[a-z_]+\s*:/.test(s)); // Filter out JSON-like content
                            
                            sentences.slice(0, 2).forEach((sentence, index) => {
                                const cleanSentence = sentence.trim();
                                if (cleanSentence && !cleanSentence.includes('N/A')) {
                                    recommendations.push({
                                        title: `Nutritional Insight`,
                                        description: cleanSentence + "."
                                    });
                                }
                            });
                        } else {
                            // Use found recommendation sentences
                            matches.slice(0, 2).forEach(match => {
                                recommendations.push({
                                    title: "AI Recommendation",
                                    description: match.trim()
                                });
                            });
                        }
                        
                        return recommendations;
                    }
                    
                    function generateBreakdownCards(carbsPercent, proteinPercent, vitaminsPercent, carbsGrams = 0, proteinGrams = 0, fatGrams = 0) {
                        return `
                            <div class="breakdown-card carbs">
                                <div class="chart-container" style="display: flex; align-items: center; justify-content: center; height: 120px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 10px;">${carbsGrams > 0 ? carbsGrams.toFixed(2) : '0'}</div>
                                        <div style="font-size: 1.2rem; color: rgba(255,255,255,0.8);">grams</div>
                                    </div>
                                </div>
                                <h3>Carbohydrates</h3>
                                <p>Your primary energy source</p>
                                <div class="description">
                                    <h3>Carbohydrates</h3>
                                    <p>Carbs are your body's main source of energy. They include sugars, starches, and fibers.</p>
                                    <p>Found in: Bread, pasta, rice, potatoes, fruits, and vegetables.</p>
                                    <p>Recommended: 45-65% of daily calories.</p>
                                    ${carbsGrams > 0 ? `<p><strong>Amount: ${carbsGrams.toFixed(2)}g</strong></p>` : ''}
                                </div>
                            </div>
                            
                            <div class="breakdown-card protein">
                                <div class="chart-container" style="display: flex; align-items: center; justify-content: center; height: 120px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 10px;">${proteinGrams > 0 ? proteinGrams.toFixed(2) : '0'}</div>
                                        <div style="font-size: 1.2rem; color: rgba(255,255,255,0.8);">grams</div>
                                    </div>
                                </div>
                                <h3>Protein</h3>
                                <p>Essential for muscle growth</p>
                                <div class="description">
                                    <h3>Protein</h3>
                                    <p>Proteins are essential for building and repairing tissues, making enzymes, and supporting immune function.</p>
                                    <p>Found in: Meat, fish, eggs, dairy, beans, nuts, and tofu.</p>
                                    <p>Recommended: 10-35% of daily calories.</p>
                                    ${proteinGrams > 0 ? `<p><strong>Amount: ${proteinGrams.toFixed(2)}g</strong></p>` : ''}
                                </div>
                            </div>
                            
                            <div class="breakdown-card vitamins">
                                <div class="chart-container" style="display: flex; align-items: center; justify-content: center; height: 120px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 3rem; font-weight: bold; color: white; margin-bottom: 10px;">${fatGrams > 0 ? fatGrams.toFixed(2) : '0'}</div>
                                        <div style="font-size: 1.2rem; color: rgba(255,255,255,0.8);">grams</div>
                                    </div>
                                </div>
                                <h3>Fats</h3>
                                <p>Essential fatty acids</p>
                                <div class="description">
                                    <h3>Fats</h3>
                                    <p>Essential nutrients that provide energy and support cell function. Fats provide essential fatty acids.</p>
                                    <p>Found in: Nuts, oils, dairy, meat, and fish.</p>
                                    <p>Recommended: 20-35% of daily calories.</p>
                                    ${fatGrams > 0 ? `<p><strong>Amount: ${fatGrams.toFixed(2)}g</strong></p>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Initialize calorie tracker when user is logged in
                    if ((isLoggedIn && userDataString) || idToken) {
                        setTimeout(async () => {
                            // Skip API call - use local data
                            await initializeCalorieTracker();
                            initializeWaterTracker(); // Initialize water tracker
                            setupFoodBrowser();
                            updateCalorieChart();
                            setupHealthInfoModal();

                            autoLoadImageLibrary(); // Auto-load user images
                            updateBreakdownCards(); // Update breakdown cards with Bedrock data
                            updateRecommendations(); // Update recommendations with Bedrock data
                            
                        }, 100); // Small delay to ensure DOM is ready
                    }
                    
                    // Quick Add Calories Function
                    window.quickAddCalories = function(calories) {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
                        const dailyGoal = parseInt(localStorage.getItem(`dailyCalorieGoal_${userId}`) || '2000');
                        const newTotal = currentConsumed + calories;
                        
                        localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
                        
                        const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
                        foodEntries.push({
                            userId: userId,
                            calories: calories,
                            name: `Quick Add ${calories} calories`,
                            timestamp: new Date().toISOString(),
                            source: 'quick_add'
                        });
                        localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
                        
                        updateCalorieDisplay(dailyGoal, newTotal);
                        updateCalorieChart();
                    };
                    
                    // Celebration Functions
                    function showCalorieGoalCelebration() {
                        addDancingCat();
                    }
                    
                    function addDancingCat() {
                        const overlay = document.createElement('div');
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.3);
                            z-index: 99999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            pointer-events: none;
                            animation: fadeIn 0.5s ease-in;
                        `;
                        
                        const celebrationGifs = [
                            'https://media.giphy.com/media/yoJC2El7xJkYCadlWE/giphy.gif',
                            'https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif',
                            'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif',
                            
                        ];
                        
                        const randomGif = celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
                        
                        const celebrationGif = document.createElement('img');
                        celebrationGif.src = randomGif;
                        celebrationGif.style.cssText = `
                            width: 400px;
                            height: 400px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                            animation: catCelebration 3s ease-in-out;
                        `;
                        
                        const congratsText = document.createElement('div');
                        congratsText.innerHTML = 'üéâ Goal Achieved! üéâ';
                        congratsText.style.cssText = `
                            position: absolute;
                            top: 20%;
                            font-size: 3rem;
                            color: white;
                            font-weight: bold;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                            animation: textBounce 3s ease-in-out;
                        `;
                        
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes fadeIn {
                                0% { opacity: 0; }
                                100% { opacity: 1; }
                            }
                            @keyframes catCelebration {
                                0%, 100% { transform: scale(1) rotate(0deg); }
                                25% { transform: scale(1.1) rotate(-5deg); }
                                50% { transform: scale(1.2) rotate(0deg); }
                                75% { transform: scale(1.1) rotate(5deg); }
                            }
                            @keyframes textBounce {
                                0%, 100% { transform: translateY(0); }
                                25% { transform: translateY(-20px); }
                                50% { transform: translateY(-30px); }
                                75% { transform: translateY(-20px); }
                            }
                        `;
                        document.head.appendChild(style);
                        overlay.appendChild(congratsText);
                        overlay.appendChild(celebrationGif);
                        document.body.appendChild(overlay);
                        
                        setTimeout(() => {
                            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                            if (style.parentNode) style.parentNode.removeChild(style);
                        }, 4000);
                    }
                    
                    function showWaterGoalCelebration() {
                        // Create celebration overlay
                        const overlay = document.createElement('div');
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.3);
                            z-index: 99999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            pointer-events: none;
                            animation: fadeIn 0.5s ease-in;
                        `;
                        
                        const celebrationContent = document.createElement('div');
                        celebrationContent.style.cssText = `
                            text-align: center;
                            background: linear-gradient(135deg, #3498db, #2980b9);
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                            animation: waterCelebration 3s ease-in-out;
                        `;
                        
                        celebrationContent.innerHTML = `
                            <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 2s infinite;">üíß</div>
                            <h2 style="color: white; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Hydration Goal Achieved!</h2>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.2rem; margin: 0;">Great job staying hydrated! üéâ</p>
                        `;
                        
                        // Add animation styles
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes waterCelebration {
                                0%, 100% { transform: scale(1) rotate(0deg); }
                                25% { transform: scale(1.05) rotate(-2deg); }
                                50% { transform: scale(1.1) rotate(0deg); }
                                75% { transform: scale(1.05) rotate(2deg); }
                            }
                            @keyframes bounce {
                                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                                40% { transform: translateY(-30px); }
                                60% { transform: translateY(-15px); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        overlay.appendChild(celebrationContent);
                        document.body.appendChild(overlay);
                        
                        // Remove after animation
                        setTimeout(() => {
                            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
                            if (style.parentNode) style.parentNode.removeChild(style);
                        }, 4000);
                    }
                    
                    
                    function initializeWaterTracker() {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        // Check if we need to reset daily water tracking
                        const lastWaterResetDate = localStorage.getItem(`lastWaterResetDate_${userId}`);
                        const today = new Date().toDateString();
                        
                        if (lastWaterResetDate !== today) {
                            localStorage.setItem(`waterConsumedToday_${userId}`, '0');
                            localStorage.setItem(`lastWaterResetDate_${userId}`, today);
                        }
                        
                        // Load current water intake

                    
                    // Load current water intake
                    const waterConsumed = parseInt(localStorage.getItem(`waterConsumedToday_${userId}`) || '0');
                        const waterGoal = parseInt(localStorage.getItem(`waterGoal_${userId}`) || '8');
                        
                        // Update display
                        updateWaterDisplay(waterGoal, waterConsumed);
                        
                        // Set up event listeners
                        const addWaterBtn = document.getElementById('addWaterBtn');
                        const resetWaterBtn = document.getElementById('resetWaterBtn');
                        
                        if (addWaterBtn) {
                            addWaterBtn.addEventListener('click', function() {
                                const currentConsumed = parseInt(localStorage.getItem(`waterConsumedToday_${userId}`) || '0');
                                const newTotal = currentConsumed + 1;
                                localStorage.setItem(`waterConsumedToday_${userId}`, newTotal.toString());
                                
                                updateWaterDisplay(waterGoal, newTotal);
                                
                                // Only show celebration when button is pressed AND goal is reached
                                if (currentConsumed < waterGoal && newTotal >= waterGoal) {
                                    showWaterGoalCelebration();
                                }
                            });
                        }
                        
                        if (resetWaterBtn) {
                            resetWaterBtn.addEventListener('click', function() {
                                if (confirm('Reset your water intake for today?')) {
                                    localStorage.setItem(`waterConsumedToday_${userId}`, '0');
                                    updateWaterDisplay(waterGoal, 0);
                                }
                            });
                        }
                    }
                    
                    function updateWaterDisplay(goal, consumed) {
                        document.getElementById('waterGoal').textContent = goal;
                        document.getElementById('waterConsumed').textContent = consumed;
                        
                        // Update water glasses display
                        const waterGlassesContainer = document.getElementById('waterGlasses');
                        if (waterGlassesContainer) {
                            waterGlassesContainer.innerHTML = '';
                            
                            for (let i = 0; i < goal; i++) {
                                const glass = document.createElement('div');
                                glass.style.cssText = `
                                    width: 30px;
                                    height: 40px;
                                    border: 2px solid #3498db;
                                    border-radius: 0 0 15px 15px;
                                    margin: 2px;
                                    background: ${i < consumed ? '#3498db' : 'transparent'};
                                    transition: all 0.3s ease;
                                `;
                                glass.textContent = 'üíß';
                                glass.style.display = 'flex';
                                glass.style.alignItems = 'center';
                                glass.style.justifyContent = 'center';
                                glass.style.fontSize = '16px';
                                glass.style.color = i < consumed ? 'white' : '#3498db';
                                
                                waterGlassesContainer.appendChild(glass);
                            }
                        }
                    }

                    function showCuteCatCelebration(title, message) {
                        const overlay = document.createElement('div');
                        overlay.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
                            background-size: 400% 400%; animation: gradientShift 3s ease infinite;
                            z-index: 99999; display: flex; flex-direction: column;
                            align-items: center; justify-content: center;
                        `;
                        
                        overlay.innerHTML = `
                            <div style="text-align: center; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                                <div style="font-size: 3rem; margin-bottom: 30px; animation: bounce 1s infinite;">${title}</div>
                                
                                <div style="width: 400px; height: 400px; margin: 20px auto; border-radius: 50%; overflow: hidden; border: 8px solid white; box-shadow: 0 0 30px rgba(255,255,255,0.8); animation: catBounce 0.8s ease-in-out infinite;">
                                    <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif" 
                                         style="width: 100%; height: 100%; object-fit: cover;" 
                                         onerror="this.src='https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif'">
                                </div>
                                
                                <div style="font-size: 1.8rem; margin: 30px 0; animation: pulse 2s infinite; max-width: 600px;">${message}</div>
                                
                                <button onclick="this.parentElement.parentElement.remove()" 
                                        style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; border: none; 
                                               padding: 20px 40px; border-radius: 50px; font-size: 1.4rem; cursor: pointer; 
                                               box-shadow: 0 8px 25px rgba(0,0,0,0.3); animation: buttonGlow 2s infinite;
                                               font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">üéâ Awesome! üéâ</button>
                            </div>
                            
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                <div style="position: absolute; top: 10%; left: 10%; font-size: 3rem; animation: float1 3s ease-in-out infinite;">üéä</div>
                                <div style="position: absolute; top: 20%; right: 15%; font-size: 2.5rem; animation: float2 2.5s ease-in-out infinite;">‚ú®</div>
                                <div style="position: absolute; bottom: 20%; left: 20%; font-size: 3.5rem; animation: float3 3.5s ease-in-out infinite;">üåü</div>
                                <div style="position: absolute; bottom: 15%; right: 10%; font-size: 2rem; animation: float1 2s ease-in-out infinite;">üéâ</div>
                                <div style="position: absolute; top: 50%; left: 5%; font-size: 2.8rem; animation: float2 4s ease-in-out infinite;">üí´</div>
                                <div style="position: absolute; top: 30%; right: 5%; font-size: 3rem; animation: float3 2.8s ease-in-out infinite;">üéà</div>
                            </div>
                        `;
                        
                        document.body.appendChild(overlay);
                        
                        setTimeout(() => {
                            if (overlay.parentNode) overlay.remove();
                        }, 10000);
                    }
                    
                    function addCelebrationStyles() {
                        if (document.getElementById('celebrationStyles')) return;
                        
                        const style = document.createElement('style');
                        style.id = 'celebrationStyles';
                        style.textContent = `
                            @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
                            @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-20px); } 60% { transform: translateY(-10px); } }
                            @keyframes catBounce { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.1) rotate(2deg); } }
                            @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
                            @keyframes buttonGlow { 0% { box-shadow: 0 8px 25px rgba(0,0,0,0.3); } 50% { box-shadow: 0 8px 35px rgba(255,107,107,0.6); } 100% { box-shadow: 0 8px 25px rgba(0,0,0,0.3); } }
                            @keyframes waterFill { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
                            @keyframes float1 { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-20px) rotate(10deg); } }
                            @keyframes float2 { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-15px) rotate(-8deg); } }
                            @keyframes float3 { 0%, 100% { transform: translateY(0px) rotate(0deg); } 50% { transform: translateY(-25px) rotate(5deg); } }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    // Water Tracker Functions
                    function initializeWaterTracker() {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        const userId = userData.userId || 'guest';
                        
                        // Check if we need to reset daily water tracking
                        const lastWaterResetDate = localStorage.getItem(`lastWaterResetDate_${userId}`);
                        const today = new Date().toDateString();
                        
                        if (lastWaterResetDate !== today) {
                            localStorage.setItem(`waterConsumedToday_${userId}`, '0');
                            localStorage.setItem(`lastWaterResetDate_${userId}`, today);
                        }
                        
                        const waterGoal = 8;
                        const waterConsumed = parseInt(localStorage.getItem(`waterConsumedToday_${userId}`) || '0');
                        
                        updateWaterDisplay(waterGoal, waterConsumed);
                        
                        document.getElementById('addWaterBtn').addEventListener('click', function() {
                            const currentConsumed = parseInt(localStorage.getItem(`waterConsumedToday_${userId}`) || '0');
                            const newTotal = Math.min(currentConsumed + 1, waterGoal);
                            localStorage.setItem(`waterConsumedToday_${userId}`, newTotal.toString());
                            updateWaterDisplay(waterGoal, newTotal);
                        });
                        
                        document.getElementById('resetWaterBtn').addEventListener('click', function() {
                            localStorage.setItem(`waterConsumedToday_${userId}`, '0');
                            updateWaterDisplay(waterGoal, 0);
                        });
                    }
                    
                    function updateWaterDisplay(goal, consumed) {
                        const previousConsumed = parseInt(document.getElementById('waterConsumed').textContent || '0');
                        
                        document.getElementById('waterGoal').textContent = goal;
                        document.getElementById('waterConsumed').textContent = consumed;
                        
                        const glassesContainer = document.getElementById('waterGlasses');
                        glassesContainer.innerHTML = '';
                        
                        for (let i = 0; i < goal; i++) {
                            const glass = document.createElement('div');
                            glass.style.width = '30px';
                            glass.style.height = '40px';
                            glass.style.border = '2px solid #3498db';
                            glass.style.borderRadius = '0 0 15px 15px';
                            glass.style.position = 'relative';
                            glass.style.cursor = 'pointer';
                            
                            if (i < consumed) {
                                glass.style.background = 'linear-gradient(to top, #3498db 0%, #5dade2 100%)';
                                // Add water drop animation for newly filled glasses
                                if (i >= previousConsumed) {
                                    glass.style.animation = 'waterFill 0.5s ease-in-out';
                                }
                            } else {
                                glass.style.background = 'transparent';
                            }
                            
                            glass.addEventListener('click', function() {
                                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                                const userId = userData.userId || 'guest';
                                localStorage.setItem(`waterConsumedToday_${userId}`, (i + 1).toString());
                                updateWaterDisplay(goal, i + 1);
                            });
                            
                            glassesContainer.appendChild(glass);
                        }
                        
                        // Show celebration when water goal is reached
                        if (previousConsumed < goal && consumed >= goal) {
                            showWaterGoalCelebration();
                        }
                    }
                    
                    // Function to fetch user profile from DynamoDB
                    async function fetchUserProfile() {
                        const accessToken = localStorage.getItem('access_token');
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        
                        if (accessToken && userData.userId) {
                            try {
                                const response = await fetch(`https://jw3ek8r5r0.execute-api.us-east-1.amazonaws.com/Prod/user/${userData.userId}`, {
                                    method: 'GET',
                                    headers: {
                                        'Authorization': `Bearer ${accessToken}`
                                    }
                                });
                                
                                if (response.ok) {
                                    const profileData = await response.json();
                                    // Merge with existing userData
                                    const updatedUserData = { ...userData, ...profileData };
                                    localStorage.setItem('userData', JSON.stringify(updatedUserData));
                                    
                                    // Update calorie goal display if available
                                    if (profileData.calorieGoal) {
                                        const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userData.userId}`) || '0');
                                        updateCalorieDisplay(profileData.calorieGoal, currentConsumed);
                                    }
                                    
                                    return updatedUserData;
                                }
                            } catch (error) {
                                console.log('Profile fetch failed, using local data:', error);
                            }
                        }
                        return userData;
                    }
                    
                    // Health Info Modal Functions
                    window.openHealthInfoModal = function() {
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        
                        // Pre-fill form with existing data
                        document.getElementById('modalAge').value = userData.age || '';
                        document.getElementById('modalWeight').value = userData.weight || '';
                        document.getElementById('modalHeight').value = userData.height || '';
                        document.getElementById('modalCalorieGoal').value = userData.calorieGoal || 2000;
                        
                        document.getElementById('healthInfoModal').style.display = 'block';
                    };
                    
                    function setupHealthInfoModal() {
                        const modal = document.getElementById('healthInfoModal');
                        const closeBtn = document.getElementById('closeHealthInfoBtn');
                        const form = document.getElementById('healthInfoForm');
                        
                        closeBtn.addEventListener('click', function() {
                            modal.style.display = 'none';
                        });
                        
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            
                            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                            const updatedData = {
                                ...userData,
                                age: document.getElementById('modalAge').value ? parseInt(document.getElementById('modalAge').value) : null,
                                weight: document.getElementById('modalWeight').value ? parseFloat(document.getElementById('modalWeight').value) : null,
                                height: document.getElementById('modalHeight').value ? parseInt(document.getElementById('modalHeight').value) : null,
                                calorieGoal: document.getElementById('modalCalorieGoal').value ? parseInt(document.getElementById('modalCalorieGoal').value) : 2000
                            };
                            
                            // Save to DynamoDB
                            const accessToken = localStorage.getItem('access_token');
                            fetch(`https://jw3ek8r5r0.execute-api.us-east-1.amazonaws.com/Prod/user`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${accessToken}`
                                },
                                body: JSON.stringify(updatedData)
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                localStorage.setItem('userData', JSON.stringify(updatedData));
                                modal.style.display = 'none';
                                
                                // Hide the banner after first completion
                                const banner = document.getElementById('healthInfoBanner');
                                if (banner && (updatedData.age || updatedData.weight || updatedData.height)) {
                                    banner.style.display = 'none';
                                }
                                
                                alert('Health information saved successfully!');
                            })
                            .catch(error => {
                                console.error('Error saving health info:', error);
                                // Still save locally even if API fails
                                localStorage.setItem('userData', JSON.stringify(updatedData));
                                modal.style.display = 'none';
                                alert('Health information saved locally. Server sync may have failed.');
                            });
                        });
                    }
            
                    // Show/hide health info banner based on user data
                    const currentUserData = JSON.parse(localStorage.getItem('userData') || '{}');
                    const banner = document.getElementById('healthInfoBanner');
                    if (banner) {
                        if (currentUserData.age || currentUserData.weight || currentUserData.height) {
                            banner.style.display = 'none';
                        } else {
                            banner.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('Error in user initialization:', error);
                }
            }
        });
    </script>
</body>
</html>
