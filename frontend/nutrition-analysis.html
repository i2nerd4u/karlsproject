<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Analysis - MealMate</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .analysis-card.collapsed {
            display: flex;
            align-items: center;
            padding: 20px;
            cursor: pointer;
        }
        
        .analysis-card.collapsed:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .analysis-card.expanded {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
        }
        
        .image-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            position: relative;
        }
        
        .image-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        
        .image-section img {
            max-width: 100%;
            max-height: 280px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }
        
        .collapsed-preview {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .collapsed-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .collapsed-info {
            flex: 1;
        }
        
        .collapsed-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            color: #2c3e50;
            line-height: 1.3;
        }
        
        .collapsed-date {
            font-size: 0.95rem;
            color: #6c757d;
            margin: 8px 0 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .calorie-badge {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .expand-icon {
            font-size: 1.4rem;
            color: #3498db;
            margin-left: 15px;
            transition: transform 0.3s ease;
        }
        
        .analysis-card.collapsed:hover .expand-icon {
            transform: scale(1.1);
        }
        
        .analysis-content {
            padding: 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .nutrition-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }
        
        .nutrition-item:hover {
            transform: translateY(-2px);
        }
        
        .nutrition-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nutrition-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .ai-description {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(44, 62, 80, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .ai-description::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.1) 0%, transparent 50%);
        }
        
        .ai-description h4 {
            position: relative;
            z-index: 1;
        }
        
        .ai-description div {
            position: relative;
            z-index: 1;
        }
        
        .week-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border-left: 4px solid #3498db;
        }
        
        .week-title {
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .week-count {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            box-shadow: 0 4px 16px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 8px 24px rgba(39, 174, 96, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        @media (max-width: 768px) {
            .analysis-card.expanded {
                grid-template-columns: 1fr;
            }
            
            .image-section {
                max-height: 250px;
                padding: 20px;
            }
            
            .analysis-content {
                padding: 25px;
            }
            
            .nutrition-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html" class="logo" style="text-decoration: none; color: inherit; font-size: 1.5rem; font-weight: bold;">MealMate</a>
        <div class="auth-buttons">
            <a href="user_dashboard.html" class="btn" style="background: #2c3e50; color: white; margin-right: 10px;">Dashboard</a>
            <a href="index.html" class="btn btn-signin">Home</a>
        </div>
    </header>

    <main class="main-content">
        <section class="welcome-section">
            <h1 class="welcome-title">ü§ñ AI Nutrition Analysis</h1>
            <p class="welcome-subtitle">AI-powered insights from your uploaded food labels</p>
            
            <div id="analysisContainer">
                <!-- Weekly sections will be populated here -->
            </div>
            
            <div id="noDataMessage" style="text-align: center; padding: 40px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px;">
                <h3>No Food Labels Found</h3>
                <p>Upload some food labels to see AI-powered nutrition analysis!</p>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto;">
            <div></div>
            <a href="meal-planner.html" class="btn" style="background: #2c3e50; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 14px;">Weekly Meal Planner</a>
        </div>
    </footer>

    <script src="aws-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadNutritionAnalysis();
        });
        
        function loadNutritionAnalysis() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const userId = userData.userId || 'guest';
            
            const aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
            const userAIEntries = aiAnalysisEntries.filter(entry => entry.userId === userId);
            
            const container = document.getElementById('analysisContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (userAIEntries.length === 0) {
                container.style.display = 'none';
                noDataMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noDataMessage.style.display = 'none';
            
            const groupedImages = groupImagesByWeek(userAIEntries);
            
            Object.keys(groupedImages).sort().reverse().forEach(weekKey => {
                const weekSection = createWeekSection(weekKey, groupedImages[weekKey]);
                container.appendChild(weekSection);
            });
        }
        
        function groupImagesByWeek(images) {
            const grouped = {};
            
            images.forEach(image => {
                const uploadDate = new Date(image.timestamp || Date.now());
                const weekStart = getWeekStart(uploadDate);
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!grouped[weekKey]) {
                    grouped[weekKey] = {
                        weekStart: weekStart,
                        images: []
                    };
                }
                
                grouped[weekKey].images.push(image);
            });
            
            return grouped;
        }
        
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }
        
        function createWeekSection(weekKey, weekData) {
            const section = document.createElement('div');
            section.style.marginBottom = '40px';
            
            const weekTitle = document.createElement('h3');
            weekTitle.className = 'week-header';
            
            const weekEnd = new Date(weekData.weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            weekTitle.innerHTML = `
                <div class="week-title">
                    üìÖ Week of ${weekData.weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}
                    <span class="week-count">${weekData.images.length} uploads</span>
                </div>
            `;
            
            section.appendChild(weekTitle);
            
            const weekGrid = document.createElement('div');
            weekGrid.className = 'analysis-grid';
            weekGrid.style.gap = '15px';
            
            weekData.images.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
            
            weekData.images.forEach(image => {
                const analysisCard = createAnalysisCard(image);
                weekGrid.appendChild(analysisCard);
            });
            
            section.appendChild(weekGrid);
            return section;
        }
        
        function createAnalysisCard(image) {
            const card = document.createElement('div');
            card.className = 'analysis-card collapsed';
            card.id = `card-${image.id}`;
            
            const uploadDate = new Date(image.timestamp).toLocaleDateString();
            
            card.innerHTML = `
                <div class="collapsed-preview">
                    <img src="${image.imageData}" alt="${image.filename}" class="collapsed-image">
                    <div class="collapsed-info">
                        <h3 class="collapsed-title">${image.foodName || image.filename}</h3>
                        <p class="collapsed-date">${uploadDate} ‚Ä¢ ${image.calories || 0} calories</p>
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
            `;
            
            card.addEventListener('click', () => toggleCard(image.id));
            
            return card;
        }
        
        function toggleCard(imageId) {
            const card = document.getElementById(`card-${imageId}`);
            const isExpanded = card.classList.contains('expanded');
            
            document.querySelectorAll('.analysis-card.expanded').forEach(c => {
                if (c.id !== `card-${imageId}`) {
                    c.classList.remove('expanded');
                    c.classList.add('collapsed');
                }
            });
            
            if (isExpanded) {
                card.classList.remove('expanded');
                card.classList.add('collapsed');
                card.innerHTML = createCollapsedView(imageId);
                card.addEventListener('click', () => toggleCard(imageId));
            } else {
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                card.innerHTML = createExpandedView(imageId);
            }
        }
        
        function createCollapsedView(imageId) {
            const aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
            const image = aiAnalysisEntries.find(e => e.id === imageId);
            
            if (!image) return '';
            
            const uploadDate = new Date(image.timestamp).toLocaleDateString();
            
            return `
                <div class="collapsed-preview">
                    <img src="${image.imageData}" alt="${image.filename}" class="collapsed-image">
                    <div class="collapsed-info">
                        <h3 class="collapsed-title">${image.foodName || image.filename}</h3>
                        <p class="collapsed-date">
                            üìÖ ${uploadDate}
                            <span class="calorie-badge">${image.calories || 0} cal</span>
                        </p>
                    </div>
                    <span class="expand-icon">‚ñº</span>
                </div>
            `;
        }
        
        function createExpandedView(imageId) {
            const aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
            const image = aiAnalysisEntries.find(e => e.id === imageId);
            
            if (!image) return '';
            
            let analysisData = {};
            if (image.analysis) {
                try {
                    analysisData = JSON.parse(image.analysis);
                } catch (e) {
                    analysisData = { raw_analysis: image.analysis };
                }
            }
            
            const timestamp = new Date(image.timestamp).toLocaleTimeString();
            const foodName = analysisData.food_name || image.foodName || image.filename;
            const calories = parseInt(analysisData.calories) || parseInt(image.calories) || 0;
            const nutritionFacts = {
                calories: calories,
                protein: analysisData.protein || '0g',
                carbs: analysisData.carbs || '0g', 
                fat: analysisData.fat || '0g'
            };
            const analysis_text = analysisData.analysis || image.analysis || 'No analysis available';
            
            return `
                <div class="image-section">
                    <img src="${image.imageData}" alt="${image.filename}">
                </div>
                <div class="analysis-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="background: linear-gradient(135deg, #2ecc71, #27ae60); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);">üçé</div>
                            <div>
                                <h3 style="margin: 0; color: #2ecc71; font-size: 1.5rem; font-weight: 600;">Nutrition Analysis Complete</h3>
                                <p style="margin: 0; opacity: 0.8; font-size: 0.95rem; color: #666;">${foodName}</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="background: rgba(0,0,0,0.1); padding: 6px 14px; border-radius: 20px; font-size: 12px; opacity: 0.8; font-weight: 500; color: #666;">${timestamp}</span>
                            <button onclick="deleteAnalysisEntry('${imageId}')" class="btn-danger">üóëÔ∏è</button>
                            <button onclick="toggleCard('${imageId}')" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6c757d; padding: 5px;">‚úï</button>
                        </div>
                    </div>
                    
                    <div class="nutrition-grid">
                        <div class="nutrition-item">
                            <div class="nutrition-value">${calories}</div>
                            <div class="nutrition-label">Calories</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionFacts.protein}</div>
                            <div class="nutrition-label">Protein</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionFacts.carbs}</div>
                            <div class="nutrition-label">Carbs</div>
                        </div>
                        <div class="nutrition-item">
                            <div class="nutrition-value">${nutritionFacts.fat}</div>
                            <div class="nutrition-label">Fat</div>
                        </div>
                    </div>
                    
                    <div class="ai-description">
                        <h4 style="margin: 0 0 10px 0;">üí° Health Insights</h4>
                        <div style="white-space: pre-wrap; line-height: 1.6;">${analysis_text}</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="addToCalorieTracker(${calories}, '${foodName}')" class="btn-primary">
                            ‚ûï Add ${calories || 0} calories
                        </button>
                        <a href="user_dashboard.html" class="btn-primary">
                            üìä View Dashboard
                        </a>
                    </div>
                </div>
            `;
        }
        
        window.addToCalorieTracker = function(calories, foodName) {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const userId = userData.userId || 'guest';
            
            if (calories <= 0) return;
            
            const currentConsumed = parseInt(localStorage.getItem(`caloriesConsumedToday_${userId}`) || '0');
            const newTotal = currentConsumed + calories;
            localStorage.setItem(`caloriesConsumedToday_${userId}`, newTotal.toString());
            
            const foodEntries = JSON.parse(localStorage.getItem('foodEntries') || '[]');
            foodEntries.push({
                userId: userId,
                calories: calories,
                name: foodName,
                timestamp: new Date().toISOString(),
                source: 'nutrition_analysis'
            });
            localStorage.setItem('foodEntries', JSON.stringify(foodEntries));
            
            event.target.textContent = '‚úÖ Added to tracker';
            event.target.className = 'btn-primary btn-success';
            event.target.disabled = true;
        };
        
        window.deleteAnalysisEntry = function(imageId) {
            if (!confirm('Are you sure you want to delete this analysis entry?')) {
                return;
            }
            
            // Remove from aiAnalysisEntries
            let aiAnalysisEntries = JSON.parse(localStorage.getItem('aiAnalysisEntries') || '[]');
            aiAnalysisEntries = aiAnalysisEntries.filter(entry => entry.id !== imageId);
            localStorage.setItem('aiAnalysisEntries', JSON.stringify(aiAnalysisEntries));
            
            // Reload the page to refresh the display
            location.reload();
        };
    </script>
</body>
</html>